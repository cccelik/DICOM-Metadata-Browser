<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Study Details - DICOM Metadata Browser</title>
    <link rel="stylesheet" href="https://unpkg.com/@phosphor-icons/web@2.1.1/src/regular/style.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .back-link {
            display: inline-block;
            margin-bottom: 20px;
            color: #3498db;
            text-decoration: none;
            font-size: 14px;
        }
        
        .back-link:hover {
            text-decoration: underline;
        }
        
        .header-section {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        h1 {
            color: #2c3e50;
            margin-bottom: 20px;
        }
        
        .info-section {
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .info-section h2 {
            color: #2c3e50;
            font-size: 18px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #ecf0f1;
        }
        
        .info-value {
            color: #2c3e50;
            font-size: 14px;
            word-break: break-word;
        }

        .info-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        .info-table th,
        .info-table td {
            text-align: left;
            padding: 8px 10px;
            border-bottom: 1px solid #f0f0f0;
            vertical-align: top;
        }

        .info-table th {
            width: 200px;
            color: #7f8c8d;
            font-weight: 500;
        }
        
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            margin-right: 5px;
        }
        
        .badge-modality {
            background: #e3f2fd;
            color: #1976d2;
        }
        
        .badge-manufacturer {
            background: #f3e5f5;
            color: #7b1fa2;
        }
        
        .series-table {
            width: 100%;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow-x: auto;
            overflow-y: hidden;
            -webkit-overflow-scrolling: touch;
        }
        
        .series-table table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1100px;
        }
        
        .series-table > table th {
            background: #34495e;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 500;
            font-size: 14px;
        }
        
        .series-table td {
            padding: 12px;
            border-bottom: 1px solid #ecf0f1;
            font-size: 14px;
        }
        
        .series-table tr:hover {
            background: #f8f9fa;
        }
        
        .series-table tr:last-child td {
            border-bottom: none;
        }
        
        .expandable {
            cursor: pointer;
            color: #3498db;
        }

        .expandable:hover {
            text-decoration: underline;
        }

        .detail-panel {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 4px;
        }

        .detail-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .detail-table th,
        .detail-table td {
            text-align: left;
            padding: 6px 8px;
            border-bottom: 1px solid #e1e6ee;
            vertical-align: top;
            background: #f8f9fa;
        }

        .detail-table {
            margin-bottom: 12px;
        }

        .detail-table th {
            width: 220px;
            color: #2c3e50;
            font-weight: 600;
            background: #eef2f7;
        }

        .detail-panel-section {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #dee2e6;
        }

        .detail-panel-section:not(:first-of-type) {
            margin-top: 18px;
        }

        .detail-panel-divider {
            margin-top: 15px;
            margin-bottom: 15px;
            padding-top: 15px;
            padding-bottom: 15px;
            border-top: 1px solid #dee2e6;
            border-bottom: 1px solid #dee2e6;
        }

        .detail-panel-title {
            color: #2c3e50;
            font-size: 14px;
        }

        .detail-panel-subsection {
            margin-top: 12px;
            padding-top: 10px;
            border-top: 1px dashed #dee2e6;
        }

        .detail-panel-subtitle {
            color: #5b6b7b;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.04em;
        }

        body.dark {
            background: #0f141b;
            color: #e6edf3;
        }

        body.dark .header-section,
        body.dark .info-section,
        body.dark .series-table {
            background: #141c26;
            box-shadow: 0 2px 4px rgba(0,0,0,0.35);
        }

        body.dark .info-table th,
        body.dark .info-table td {
            border-bottom-color: #243244;
        }

        body.dark .info-value,
        body.dark h1,
        body.dark h2 {
            color: #e6edf3;
        }

        body.dark .series-table th {
            background: #1e2936;
            color: #e6edf3;
        }

        body.dark .series-table td {
            border-bottom-color: #243244;
        }

        body.dark .series-table tr:hover {
            background: #18212d;
        }

        body.dark .badge-modality {
            background: #1f3248;
            color: #90c2ff;
        }

        body.dark .badge-manufacturer {
            background: #30203b;
            color: #d1a4ff;
        }

        body.dark .detail-panel {
            background: #101922;
        }

        body.dark .detail-panel-section {
            border-bottom-color: #243244;
        }

        body.dark .detail-table th,
        body.dark .detail-table td {
            border-bottom-color: #243244;
            background: #101922;
        }

        body.dark .detail-table th {
            color: #e6edf3;
            background: #1b2532;
        }

        body.dark .detail-panel-divider {
            border-top-color: #243244;
            border-bottom-color: #243244;
        }

        body.dark .detail-panel-title {
            color: #e6edf3;
        }

        body.dark .detail-panel-subsection {
            border-top-color: #243244;
        }

        body.dark .detail-panel-subtitle {
            color: #9aa7b5;
        }

        body.dark .detail-panel strong {
            color: #e6edf3;
        }

        .action-buttons {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .export-button {
            padding: 8px 16px;
            background: #1abc9c;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: background 0.2s ease;
        }

        .export-button:hover {
            background: #169f82;
        }

        body.dark .export-button {
            background: #1f8f7a;
        }

        body.dark .export-button:hover {
            background: #177564;
        }

    </style>
    {% include "partials/top_bar/styles.html" %}
    {% include "partials/modals/export/styles.html" %}
    {% include "partials/create_databank_styles.html" %}
</head>
<body>
    {% from "partials/top_bar/top_bar.html" import render_top_bar %}
    {% set lang_url_template = '/?db=' ~ db_name ~ '&lang=%s' %}
    {% set databank_url_template = '/study/' ~ study_info.study_instance_uid ~ '?db=%s&lang=%s' %}
    {% call render_top_bar('top-study-hamburger', 'top-study-menu', '&nbsp;', lang_url_template, databank_url_template, t, lang, db_name, databanks) %}
        <a href="/dashboard?db={{ db_name }}">{{ t.dashboard }}</a>
    {% endcall %}
    <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <a href="/?db={{ db_name }}&lang={{ lang }}" class="back-link">← {{ t.back_to_studies }}</a>
            <div class="action-buttons">
                <button type="button" id="export-csv-button" class="export-button">
                    {{ t.export_csv }}
                </button>
                <form method="POST" action="/study/{{ study_info.study_instance_uid }}/delete?db={{ db_name }}" 
                      style="margin: 0;" 
                      onsubmit="return confirm('{{ t.delete_confirm }}');">
                    <button type="submit" 
                            style="padding: 8px 16px; background: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: 500;"
                            onmouseover="this.style.background='#c0392b'"
                            onmouseout="this.style.background='#e74c3c'">
                        {{ t.delete_study }}
                    </button>
                </form>
            </div>
        </div>
        
        <div class="header-section">
            <h1>
                {% if study_info.patient_name_display %}
                    {{ study_info.patient_name_display }}
                {% elif study_info.patient_name %}
                    {{ study_info.patient_name }}
                {% else %}
                    Study Details
                {% endif %}
            </h1>
            <table class="info-table">
                <tr>
                    <th>{{ t.study_uid }}</th>
                    <td><small style="color: #7f8c8d; word-break: break-all;">{{ study_info.study_instance_uid }}</small></td>
                </tr>
                <tr>
                    <th>{{ t.patient_id }}</th>
                    <td>{{ study_info.patient_id or 'N/A' }}</td>
                </tr>
                <tr>
                    <th>{{ t.study_date }}</th>
                    <td>{{ study_info.study_date_formatted or study_info.study_date or 'N/A' }}</td>
                </tr>
            </table>
        </div>
        
        <div class="info-section">
            <h2>{{ t.patient_information }}</h2>
            <table class="info-table">
                <tr>
                    <th>{{ t.patient_name }}</th>
                    <td class="info-value">{{ study_info.patient_name or 'N/A' }}</td>
                </tr>
                <tr>
                    <th>{{ t.patient_id }}</th>
                    <td class="info-value">{{ study_info.patient_id or 'N/A' }}</td>
                </tr>
                <tr>
                    <th>{{ t.patient_birth_date }}</th>
                    <td class="info-value">{{ study_info.patient_birth_date_formatted or study_info.patient_birth_date or 'N/A' }}</td>
                </tr>
                <tr>
                    <th>{{ t.patient_sex }}</th>
                    <td class="info-value">{{ study_info.patient_sex or 'N/A' }}</td>
                </tr>
                <tr>
                    <th>{{ t.patient_age }}</th>
                    <td class="info-value">{{ study_info.patient_age or 'N/A' }}</td>
                </tr>
                <tr>
                    <th>{{ t.patient_weight }}</th>
                    <td class="info-value">{% if study_info.patient_weight %}{{ "%.2f"|format(study_info.patient_weight) }} kg{% else %}N/A{% endif %}</td>
                </tr>
                {% if study_info.patient_size %}
                <tr>
                    <th>{{ t.patient_height }}</th>
                    <td class="info-value">
                        {{ "%.2f"|format(study_info.patient_size) }} m
                        {% if study_info.height_cm %}
                        <span style="color: #7f8c8d; font-size: 12px;">({{ "%.0f"|format(study_info.height_cm) }} cm)</span>
                        {% endif %}
                    </td>
                </tr>
                {% endif %}
                {% if study_info.bmi %}
                <tr>
                    <th>{{ t.bmi }}</th>
                    <td class="info-value">
                        {{ "%.1f"|format(study_info.bmi) }}
                        {% if study_info.bmi < 18.5 %}
                        <span style="color: #3498db; font-size: 12px;">{% if lang == 'de' %}(Untergewicht){% else %}(Underweight){% endif %}</span>
                        {% elif study_info.bmi < 25 %}
                        <span style="color: #27ae60; font-size: 12px;">{% if lang == 'de' %}(Normal){% else %}(Normal){% endif %}</span>
                        {% elif study_info.bmi < 30 %}
                        <span style="color: #f39c12; font-size: 12px;">{% if lang == 'de' %}(Übergewicht){% else %}(Overweight){% endif %}</span>
                        {% else %}
                        <span style="color: #e74c3c; font-size: 12px;">{% if lang == 'de' %}(Adipös){% else %}(Obese){% endif %}</span>
                        {% endif %}
                    </td>
                </tr>
                {% endif %}
            </table>
        </div>
        
        <div class="info-section">
            <h2>{{ t.study_information }}</h2>
            <table class="info-table">
                <tr>
                    <th>{{ t.study_date }}</th>
                    <td class="info-value">{{ study_info.study_date_formatted or study_info.study_date or 'N/A' }}</td>
                </tr>
                <tr>
                    <th>{{ t.study_time }}</th>
                    <td class="info-value">{{ study_info.study_time_formatted or study_info.study_time or 'N/A' }}</td>
                </tr>
                <tr>
                    <th>{{ t.study_description }}</th>
                    <td class="info-value">{{ study_info.study_description or 'N/A' }}</td>
                </tr>
                <tr>
                    <th>{{ t.study_id }}</th>
                    <td class="info-value">{{ study_info.study_id or 'N/A' }}</td>
                </tr>
                <tr>
                    <th>{{ t.accession_number }}</th>
                    <td class="info-value">{{ study_info.accession_number or 'N/A' }}</td>
                </tr>
                <tr>
                    <th>{{ t.referring_physician }}</th>
                    <td class="info-value">{{ study_info.referring_physician_name or 'N/A' }}</td>
                </tr>
            </table>
        </div>

        {% if study_info.ctp_collection or study_info.ctp_subject_id or study_info.ctp_private_flag_raw or study_info.ctp_private_flag_int or study_info.csa_image_header_json or study_info.csa_series_header_json %}
        <div class="info-section">
            <h2>{{ t.private_tags or 'Private Tags' }}</h2>
            {% if study_info.ctp_collection or study_info.ctp_subject_id or study_info.ctp_private_flag_raw or study_info.ctp_private_flag_int %}
            <h3 style="margin: 18px 0 10px; font-size: 16px; color: #2c3e50;">{{ t.ctp_private_metadata }}</h3>
            <table class="info-table">
                {% if study_info.ctp_collection %}
                <tr>
                    <th>{{ t.ctp_collection }}</th>
                    <td class="info-value">{{ study_info.ctp_collection }}</td>
                </tr>
                {% endif %}
                {% if study_info.ctp_subject_id %}
                <tr>
                    <th>{{ t.ctp_subject_id }}</th>
                    <td class="info-value">{{ study_info.ctp_subject_id }}</td>
                </tr>
                {% endif %}
                {% if study_info.ctp_private_flag_raw %}
                <tr>
                    <th>{{ t.ctp_private_flag_raw }}</th>
                    <td class="info-value">{{ study_info.ctp_private_flag_raw }}</td>
                </tr>
                {% endif %}
                {% if study_info.ctp_private_flag_int is not none %}
                <tr>
                    <th>{{ t.ctp_private_flag_int }}</th>
                    <td class="info-value">{{ study_info.ctp_private_flag_int }}</td>
                </tr>
                {% endif %}
            </table>
            {% endif %}
            {% if study_info.csa_image_header_json or study_info.csa_series_header_json %}
            <h3 style="margin: 18px 0 10px; font-size: 16px; color: #2c3e50;">{{ t.csa_private_metadata or 'Siemens CSA' }}</h3>
            <table class="info-table">
                {% if study_info.csa_image_header_json or study_info.csa_image_header_hash %}
                <tr>
                    <th>{{ t.csa_image_header or 'CSA Image Header' }}</th>
                    <td class="info-value">
                        <div class="csa-summary"
                             data-csa='{{ study_info.csa_image_header_json|e }}'
                             data-hash="{{ study_info.csa_image_header_hash or '' }}"></div>
                    </td>
                </tr>
                {% endif %}
                {% if study_info.csa_series_header_json or study_info.csa_series_header_hash %}
                <tr>
                    <th>{{ t.csa_series_header or 'CSA Series Header' }}</th>
                    <td class="info-value">
                        <div class="csa-summary"
                             data-csa='{{ study_info.csa_series_header_json|e }}'
                             data-hash="{{ study_info.csa_series_header_hash or '' }}"></div>
                    </td>
                </tr>
                {% endif %}
            </table>
            {% endif %}
        </div>
        {% endif %}
        
        <div class="info-section">
            <h2>{{ t.manufacturer_information }}</h2>
            <table class="info-table">
                <tr>
                    <th>{{ t.manufacturer }}</th>
                    <td class="info-value">{{ study_info.manufacturer or 'N/A' }}</td>
                </tr>
                <tr>
                    <th>{{ t.model }}</th>
                    <td class="info-value">{{ study_info.manufacturer_model_name or 'N/A' }}</td>
                </tr>
                <tr>
                    <th>{{ t.institution }}</th>
                    <td class="info-value">{{ study_info.institution_name or 'N/A' }}</td>
                </tr>
            </table>
        </div>
        
        
        <div class="info-section">
            <h2>{{ t.series }} ({{ series|length }})</h2>
            {% if series %}
            <div class="series-table">
                <table>
                    <thead>
                        <tr>
                            <th>{{ t.series_number }}</th>
                            <th>{{ t.description }}</th>
                            <th>{{ t.modality }}</th>
                            <th>{{ t.injection_time }}</th>
                            <th>{{ t.acquisition_datetime }}</th>
                            <th>{{ t.injection_delay }}</th>
                            <th>{{ t.manufacturer }}</th>
                            <th>{{ t.details }}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for s in series %}
                        <tr>
                            <td>{{ s.series_number or 'N/A' }}</td>
                            <td>{{ s.series_description or 'N/A' }}</td>
                            <td>
                                {% if s.modality %}
                                <span class="badge badge-modality">{{ s.modality }}</span>
                                {% else %}
                                N/A
                                {% endif %}
                            </td>
                            <td>
                                {% if s.injection_time_formatted %}
                                    {{ s.injection_time_formatted }}
                                    {% if s.injection_date_formatted %}
                                        <br><small style="color: #7f8c8d;">{{ s.injection_date_formatted }}</small>
                                    {% elif s.injection_date %}
                                        <br><small style="color: #7f8c8d;">{{ s.injection_date }}</small>
                                    {% endif %}
                                {% elif s.injection_time %}
                                    {{ s.injection_time }}
                                {% else %}
                                    <span style="color: #bdc3c7;">N/A</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if s.acquisition_date_formatted or s.acquisition_time_formatted %}
                                    {% if s.acquisition_date_formatted %}
                                        {{ s.acquisition_date_formatted }}
                                    {% else %}
                                        {{ s.acquisition_date or 'N/A' }}
                                    {% endif %}
                                    {% if s.acquisition_time_formatted %}
                                        <br><strong>{{ s.acquisition_time_formatted }}</strong>
                                        {% if s.acquisition_likely_next_day %}
                                        <br><small style="color: #7f8c8d;">({{ t.likely_next_day }})</small>
                                        {% endif %}
                                    {% else %}
                                        <br><small>{{ s.acquisition_time or '' }}</small>
                                    {% endif %}
                                {% else %}
                                    {{ s.series_date_formatted or s.series_date or 'N/A' }}
                                    {% if s.series_time_formatted %}
                                    <br><small>{{ s.series_time_formatted }}</small>
                                    {% endif %}
                                {% endif %}
                            </td>
                            <td>
                                {% if s.injection_delay %}
                                    <span style="color: #3498db; font-weight: 500;">{{ s.injection_delay }}</span>
                                {% else %}
                                    <span style="color: #bdc3c7;">N/A</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if s.manufacturer %}
                                <span class="badge badge-manufacturer">{{ s.manufacturer }}</span>
                                {% else %}
                                N/A
                                {% endif %}
                            </td>
                            <td>
                                <span
                                    class="expandable"
                                    data-show="{{ t.show_details }}"
                                    data-hide="{{ t.hide_details }}"
                                    onclick="toggleDetails('series-{{ loop.index }}', this)"
                                >{{ t.show_details }}</span>
                            </td>
                        </tr>
                        <tr id="series-{{ loop.index }}" style="display: none;">
                            <td colspan="8">
                                <div class="detail-panel">
                                    {% set has_nm = s.radiopharmaceutical or s.injected_activity or s.decay_correction or s.activity_at_scan or s.activity_per_kg or s.radiopharmaceutical_volume or s.radionuclide_total_dose or s.pet_dose_report %}
                                    {% set has_private_details = s.csa_image_header_json or s.csa_series_header_json or s.csa_image_header_hash or s.csa_series_header_hash or s.private_payload_fingerprint or (s.private_creators and s.private_creators|length) or (s.pipeline_provenance and s.pipeline_provenance|length) or (s.rt_provenance and s.rt_provenance|length) %}
                                    {% if has_nm or has_private_details %}
                                    {% if has_nm %}
                                    <div class="detail-panel-section">
                                        <strong class="detail-panel-title">{{ t.nuclear_medicine_information }}</strong>
                                    </div>
                                    <table class="detail-table">
                                        {% if s.radiopharmaceutical %}
                                        <tr>
                                            <th>{{ t.radiopharmaceutical }}</th>
                                            <td>{{ s.radiopharmaceutical }}</td>
                                        </tr>
                                        {% endif %}
                                        {% if s.injected_activity %}
                                        {% if s.injected_activity > 1e6 %}
                                        <tr>
                                            <th>{{ t.injected_activity }}</th>
                                            <td>{{ "%.2f"|format(s.injected_activity / 1e6) }} MBq <span style="color: #7f8c8d; font-size: 12px;">({{ "%.0f"|format(s.injected_activity) }} Bq)</span></td>
                                        </tr>
                                        {% else %}
                                        <tr>
                                            <th>{{ t.injected_activity }}</th>
                                            <td>{{ "%.2f"|format(s.injected_activity) }} MBq</td>
                                        </tr>
                                        {% endif %}
                                        {% endif %}
                                        {% if s.injection_time_formatted or s.injection_time %}
                                        <tr>
                                            <th>{{ t.injection_time }}</th>
                                            <td>{{ s.injection_time_formatted or s.injection_time }}{% if s.injection_date_formatted %} ({{ s.injection_date_formatted }}){% endif %}</td>
                                        </tr>
                                        {% endif %}
                                        {% if s.half_life %}
                                        <tr>
                                            <th>{{ t.half_life }}</th>
                                            <td>{{ "%.2f"|format(s.half_life) }} s
                                        {% if s.half_life > 60 %}
                                            <span style="color: #7f8c8d; font-size: 12px;">({{ "%.1f"|format(s.half_life / 60) }} min)</span>
                                        {% endif %}
                                            </td>
                                        </tr>
                                        {% endif %}
                                        {% if s.decay_correction %}
                                        <tr>
                                            <th>{{ t.decay_correction }}</th>
                                            <td>{{ s.decay_correction }}</td>
                                        </tr>
                                        {% endif %}
                                        {% if s.radiopharmaceutical_volume %}
                                        <tr>
                                            <th>{{ t.radiopharmaceutical_volume }}</th>
                                            <td>{{ "%.2f"|format(s.radiopharmaceutical_volume) }} ml</td>
                                        </tr>
                                        {% endif %}
                                        {% if s.radionuclide_total_dose and s.radionuclide_total_dose != s.injected_activity %}
                                        {% if s.radionuclide_total_dose > 1e6 %}
                                        <tr>
                                            <th>{{ t.radionuclide_total_dose }}</th>
                                            <td>{{ "%.2f"|format(s.radionuclide_total_dose / 1e6) }} MBq <span style="color: #7f8c8d; font-size: 12px;">({{ "%.0f"|format(s.radionuclide_total_dose) }} Bq)</span></td>
                                        </tr>
                                        {% else %}
                                        <tr>
                                            <th>{{ t.radionuclide_total_dose }}</th>
                                            <td>{{ "%.2f"|format(s.radionuclide_total_dose) }} MBq</td>
                                        </tr>
                                        {% endif %}
                                        {% endif %}
                                        {% if s.activity_at_scan %}
                                        {% if s.activity_at_scan > 1e6 %}
                                        <tr>
                                            <th>{{ t.activity_at_scan }}</th>
                                            <td>{{ "%.2f"|format(s.activity_at_scan / 1e6) }} MBq <span style="color: #7f8c8d; font-size: 12px;">({{ "%.0f"|format(s.activity_at_scan) }} Bq)</span>
                                        {% else %}
                                        <tr>
                                            <th>{{ t.activity_at_scan }}</th>
                                            <td>{{ "%.2f"|format(s.activity_at_scan / 1e6) }} MBq <span style="color: #7f8c8d; font-size: 12px;">({{ "%.0f"|format(s.activity_at_scan) }} Bq)</span>
                                        {% endif %}
                                        {% if s.decay_percent %}
                                            <span style="color: #7f8c8d; font-size: 12px;">({{ "%.1f"|format(s.decay_percent) }}% {{ t.decayed }})</span>
                                        {% endif %}
                                            </td>
                                        </tr>
                                        {% endif %}
                                        {% if s.activity_per_kg %}
                                        {% if s.activity_per_kg > 1e6 %}
                                        <tr>
                                            <th>{{ t.activity_per_kg }}</th>
                                            <td>{{ "%.2f"|format(s.activity_per_kg / 1e6) }} MBq/kg <span style="color: #7f8c8d; font-size: 12px;">({{ "%.0f"|format(s.activity_per_kg) }} Bq/kg)</span></td>
                                        </tr>
                                        {% else %}
                                        <tr>
                                            <th>{{ t.activity_per_kg }}</th>
                                            <td>{{ "%.2f"|format(s.activity_per_kg) }} MBq/kg</td>
                                        </tr>
                                        {% endif %}
                                        {% endif %}
                                        {% if s.pet_dose_report %}
                                        <tr>
                                            <th>{{ t.pet_dose_report_private or 'PET Dose Report (Private)' }}</th>
                                            <td>
                                                {% for entry in s.pet_dose_report %}
                                                    <div>
                                                        <strong>{{ entry.name }}:</strong>
                                                        {{ entry.value or '—' }}
                                                        {% if entry.alt_value and entry.alt_value != '-1' %}
                                                            <span style="color: #7f8c8d; font-size: 12px;">({{ entry.alt_value }})</span>
                                                        {% endif %}
                                                    </div>
                                                {% endfor %}
                                            </td>
                                        </tr>
                                        {% endif %}
                                    </table>
                                    {% endif %}

                                    {% if has_private_details %}
                                    <div class="detail-panel-section">
                                        <strong class="detail-panel-title">{{ t.private_tags or 'Private Tags' }}</strong>
                                    </div>
                                    <table class="detail-table">
                                        {% if s.private_payload_fingerprint %}
                                        <tr>
                                            <th>{{ t.private_payload_fingerprint or 'Private Payload Fingerprint' }}</th>
                                            <td>{{ s.private_payload_fingerprint }}</td>
                                        </tr>
                                        {% endif %}
                                        {% if s.private_creators and s.private_creators|length %}
                                        <tr>
                                            <th>{{ t.private_creators or 'Private Creators' }}</th>
                                            <td>
                                                {% for creator, count in s.private_creators.items() %}
                                                    <div>{{ creator }} ({{ count }})</div>
                                                {% endfor %}
                                            </td>
                                        </tr>
                                        {% endif %}
                                        {% if s.protocol_name or s.radiopharmaceutical or s.injection_time or s.acquisition_time or s.acquisition_type or s.reconstruction_algorithm or s.convolution_kernel %}
                                        <tr>
                                            <th>{{ t.protocol_context or 'Protocol Context' }}</th>
                                            <td>
                                                {% if s.protocol_name %}<div><strong>{{ t.protocol_name or 'Protocol Name' }}:</strong> {{ s.protocol_name }}</div>{% endif %}
                                                {% if s.radiopharmaceutical %}<div><strong>{{ t.radiopharmaceutical }}:</strong> {{ s.radiopharmaceutical }}</div>{% endif %}
                                                {% if s.injection_time %}<div><strong>{{ t.injection_time }}:</strong> {{ s.injection_time_formatted or s.injection_time }}</div>{% endif %}
                                                {% if s.acquisition_time %}<div><strong>{{ t.acquisition_time or 'Acquisition Time' }}:</strong> {{ s.acquisition_time_formatted or s.acquisition_time }}</div>{% endif %}
                                                {% if s.acquisition_type %}<div><strong>{{ t.acquisition_type or 'Acquisition Type' }}:</strong> {{ s.acquisition_type }}</div>{% endif %}
                                                {% if s.reconstruction_algorithm %}<div><strong>{{ t.reconstruction_algorithm or 'Reconstruction Algorithm' }}:</strong> {{ s.reconstruction_algorithm }}</div>{% endif %}
                                                {% if s.convolution_kernel %}<div><strong>{{ t.convolution_kernel or 'Convolution Kernel' }}:</strong> {{ s.convolution_kernel }}</div>{% endif %}
                                            </td>
                                        </tr>
                                        {% endif %}
                                        {% if s.csa_image_header_json or s.csa_image_header_hash %}
                                        <tr>
                                            <th>{{ t.csa_image_header or 'CSA Image Header' }}</th>
                                            <td>
                                                <div class="csa-summary"
                                                     data-csa='{{ s.csa_image_header_json|e }}'
                                                     data-hash="{{ s.csa_image_header_hash or '' }}"></div>
                                            </td>
                                        </tr>
                                        {% endif %}
                                        {% if s.csa_series_header_json or s.csa_series_header_hash %}
                                        <tr>
                                            <th>{{ t.csa_series_header or 'CSA Series Header' }}</th>
                                            <td>
                                                <div class="csa-summary"
                                                     data-csa='{{ s.csa_series_header_json|e }}'
                                                     data-hash="{{ s.csa_series_header_hash or '' }}"></div>
                                            </td>
                                        </tr>
                                        {% endif %}
                                        {% if s.pipeline_provenance and s.pipeline_provenance|length %}
                                        <tr>
                                            <th>{{ t.derived_provenance or 'Derived Provenance' }}</th>
                                            <td>
                                                {% for tag in s.pipeline_provenance %}
                                                    <div>
                                                        {{ tag.creator }} ({{ tag.group_hex }},{{ tag.element_hex }}):
                                                        {{ tag.display_value or tag.value_text or tag.value_num or tag.value_hex or '—' }}
                                                    </div>
                                                {% endfor %}
                                            </td>
                                        </tr>
                                        {% endif %}
                                        {% if s.rt_provenance and s.rt_provenance|length %}
                                        <tr>
                                            <th>{{ t.rt_provenance or 'RT Provenance' }}</th>
                                            <td>
                                                {% for tag in s.rt_provenance %}
                                                    <div>
                                                        {{ tag.creator }} ({{ tag.group_hex }},{{ tag.element_hex }}):
                                                        {{ tag.display_value or tag.value_text or tag.value_num or tag.value_hex or '—' }}
                                                    </div>
                                                {% endfor %}
                                            </td>
                                        </tr>
                                        {% endif %}
                                    </table>
                                    {% endif %}

                                    {% endif %}

                                    <div class="detail-panel-section">
                                        <strong class="detail-panel-title">{{ t.series_information }}</strong>
                                    </div>
                                    <table class="detail-table">
                                        <tr>
                                            <th>{{ t.series_uid }}</th>
                                            <td>{{ s.series_instance_uid }}</td>
                                        </tr>
                                        <tr>
                                            <th>{{ t.file_path }}</th>
                                            <td>{{ s.file_path or 'N/A' }}</td>
                                        </tr>
                                        {% if s.body_part_examined %}
                                        <tr>
                                            <th>{{ t.body_part }}</th>
                                            <td>{{ s.body_part_examined }}</td>
                                        </tr>
                                        {% endif %}
                                        {% if s.protocol_name %}
                                        <tr>
                                            <th>{{ t.protocol_name or 'Protocol Name' }}</th>
                                            <td>{{ s.protocol_name }}</td>
                                        </tr>
                                        {% endif %}
                                        {% if s.slice_thickness %}
                                        <tr>
                                            <th>{{ t.slice_thickness }}</th>
                                            <td>{{ "%.2f"|format(s.slice_thickness) }} mm</td>
                                        </tr>
                                        {% endif %}
                                        {% if s.pixel_spacing %}
                                        <tr>
                                            <th>{{ t.pixel_spacing }}</th>
                                            <td>{{ s.pixel_spacing }}</td>
                                        </tr>
                                        {% endif %}
                                        {% if s.image_type %}
                                        <tr>
                                            <th>{{ t.image_type }}</th>
                                            <td>{{ s.image_type }}</td>
                                        </tr>
                                        {% endif %}
                                        {% if s.software_version %}
                                        <tr>
                                            <th>{{ t.software_version }}</th>
                                            <td>{{ s.software_version }}</td>
                                        </tr>
                                        {% endif %}
                                        {% if s.manufacturer_model_name %}
                                        <tr>
                                            <th>{{ t.model }}</th>
                                            <td>{{ s.manufacturer_model_name }}</td>
                                        </tr>
                                        {% endif %}
                                    </table>

                                    {% set has_acq = s.patient_position or s.scanning_sequence or s.sequence_variant or s.scan_options or s.acquisition_type or s.kvp or s.exposure_time or s.exposure or s.tube_current or s.spiral_pitch_factor or s.ctdivol or s.dlp or s.frame_time %}
                                    {% if has_acq %}
                                    <div class="detail-panel-divider">
                                        <strong class="detail-panel-title">{{ t.acquisition_information or 'Acquisition Information' }}</strong>
                                    </div>
                                    <table class="detail-table">
                                        {% if s.patient_position %}
                                        <tr>
                                            <th>{{ t.patient_position or 'Patient Position' }}</th>
                                            <td>{{ s.patient_position }}</td>
                                        </tr>
                                        {% endif %}
                                        {% if s.scanning_sequence %}
                                        <tr>
                                            <th>{{ t.scanning_sequence or 'Scanning Sequence' }}</th>
                                            <td>{{ s.scanning_sequence }}</td>
                                        </tr>
                                        {% endif %}
                                        {% if s.sequence_variant %}
                                        <tr>
                                            <th>{{ t.sequence_variant or 'Sequence Variant' }}</th>
                                            <td>{{ s.sequence_variant }}</td>
                                        </tr>
                                        {% endif %}
                                        {% if s.scan_options %}
                                        <tr>
                                            <th>{{ t.scan_options or 'Scan Options' }}</th>
                                            <td>{{ s.scan_options }}</td>
                                        </tr>
                                        {% endif %}
                                        {% if s.acquisition_type %}
                                        <tr>
                                            <th>{{ t.acquisition_type or 'Acquisition Type' }}</th>
                                            <td>{{ s.acquisition_type }}</td>
                                        </tr>
                                        {% endif %}
                                        {% if s.kvp %}
                                        <tr>
                                            <th>{{ t.kvp or 'KVP' }}</th>
                                            <td>{{ "%.1f"|format(s.kvp) }}</td>
                                        </tr>
                                        {% endif %}
                                        {% if s.exposure_time %}
                                        <tr>
                                            <th>{{ t.exposure_time or 'Exposure Time' }}</th>
                                            <td>{{ "%.2f"|format(s.exposure_time) }} ms</td>
                                        </tr>
                                        {% endif %}
                                        {% if s.exposure %}
                                        <tr>
                                            <th>{{ t.exposure or 'Exposure' }}</th>
                                            <td>{{ "%.2f"|format(s.exposure) }}</td>
                                        </tr>
                                        {% endif %}
                                        {% if s.tube_current %}
                                        <tr>
                                            <th>{{ t.tube_current or 'Tube Current' }}</th>
                                            <td>{{ "%.2f"|format(s.tube_current) }} mA</td>
                                        </tr>
                                        {% endif %}
                                        {% if s.spiral_pitch_factor %}
                                        <tr>
                                            <th>{{ t.spiral_pitch_factor or 'Spiral Pitch Factor' }}</th>
                                            <td>{{ "%.3f"|format(s.spiral_pitch_factor) }}</td>
                                        </tr>
                                        {% endif %}
                                        {% if s.ctdivol %}
                                        <tr>
                                            <th>{{ t.ctdivol or 'CTDIvol' }}</th>
                                            <td>{{ "%.2f"|format(s.ctdivol) }} mGy</td>
                                        </tr>
                                        {% endif %}
                                        {% if s.dlp %}
                                        <tr>
                                            <th>{{ t.dlp or 'DLP' }}</th>
                                            <td>{{ "%.2f"|format(s.dlp) }} mGy·cm</td>
                                        </tr>
                                        {% endif %}
                                        {% if s.frame_time %}
                                        <tr>
                                            <th>{{ t.frame_time or 'Frame Time' }}</th>
                                            <td>{{ "%.2f"|format(s.frame_time) }} ms</td>
                                        </tr>
                                        {% endif %}
                                    </table>
                                    {% endif %}

                                    {% set has_recon = s.reconstruction_diameter or s.reconstruction_algorithm or s.convolution_kernel or s.filter_type %}
                                    {% if has_recon %}
                                    <div class="detail-panel-divider">
                                        <strong class="detail-panel-title">{{ t.reconstruction_information or 'Reconstruction Information' }}</strong>
                                    </div>
                                    <table class="detail-table">
                                        {% if s.reconstruction_diameter %}
                                        <tr>
                                            <th>{{ t.reconstruction_diameter or 'Reconstruction Diameter' }}</th>
                                            <td>{{ "%.2f"|format(s.reconstruction_diameter) }} mm</td>
                                        </tr>
                                        {% endif %}
                                        {% if s.reconstruction_algorithm %}
                                        <tr>
                                            <th>{{ t.reconstruction_algorithm or 'Reconstruction Algorithm' }}</th>
                                            <td>{{ s.reconstruction_algorithm }}</td>
                                        </tr>
                                        {% endif %}
                                        {% if s.convolution_kernel %}
                                        <tr>
                                            <th>{{ t.convolution_kernel or 'Convolution Kernel' }}</th>
                                            <td>{{ s.convolution_kernel }}</td>
                                        </tr>
                                        {% endif %}
                                        {% if s.filter_type %}
                                        <tr>
                                            <th>{{ t.filter_type or 'Filter Type' }}</th>
                                            <td>{{ s.filter_type }}</td>
                                        </tr>
                                        {% endif %}
                                    </table>
                                    {% endif %}

                                    {% set has_image = s.image_orientation_patient or s.slice_location or s.number_of_frames or s.number_of_slices %}
                                    {% if has_image %}
                                    <div class="detail-panel-divider">
                                        <strong class="detail-panel-title">{{ t.image_information or 'Image Information' }}</strong>
                                    </div>
                                    <table class="detail-table">
                                        {% if s.image_orientation_patient %}
                                        <tr>
                                            <th>{{ t.image_orientation_patient or 'Image Orientation (Patient)' }}</th>
                                            <td>{{ s.image_orientation_patient }}</td>
                                        </tr>
                                        {% endif %}
                                        {% if s.slice_location %}
                                        <tr>
                                            <th>{{ t.slice_location or 'Slice Location' }}</th>
                                            <td>{{ "%.2f"|format(s.slice_location) }}</td>
                                        </tr>
                                        {% endif %}
                                        {% if s.number_of_slices %}
                                        <tr>
                                            <th>{{ t.number_of_slices or 'Images in Acquisition' }}</th>
                                            <td>{{ s.number_of_slices }}</td>
                                        </tr>
                                        {% endif %}
                                        {% if s.number_of_frames %}
                                        <tr>
                                            <th>{{ t.number_of_frames or 'Number of Frames' }}</th>
                                            <td>{{ s.number_of_frames }}</td>
                                        </tr>
                                        {% endif %}
                                    </table>
                                    {% endif %}
                                    
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p style="color: #7f8c8d;">{% if lang == 'de' %}Keine Serien in dieser Studie gefunden.{% else %}No series found in this study.{% endif %}</p>
            {% endif %}
        </div>
    </div>

    {% include "partials/modals/export/modal.html" %}

    {% include "partials/create_databank_modal.html" %}

    {% set menu_button_id = 'top-study-hamburger' %}
    {% set menu_id = 'top-study-menu' %}
    {% set reload_on_theme_change = false %}
    {% include "partials/top_bar/scripts.html" %}
    
    <script>
        function toggleDetails(id, triggerEl) {
            const el = document.getElementById(id);
            if (el.style.display === 'none') {
                el.style.display = '';
                if (triggerEl) {
                    triggerEl.textContent = triggerEl.dataset.hide || 'Hide Details';
                }
            } else {
                el.style.display = 'none';
                if (triggerEl) {
                    triggerEl.textContent = triggerEl.dataset.show || 'Show Details';
                }
            }
        }
    </script>
    {% include "partials/create_databank_script.html" %}
    <script>
        const exportModal = document.getElementById('export-modal');
        const exportOpenButton = document.getElementById('export-csv-button');
        const exportCloseButtons = document.querySelectorAll('[data-export-close]');
        const exportSelectAll = document.getElementById('export-select-all');
        const exportSelectNone = document.getElementById('export-select-none');
        const exportConfirm = document.getElementById('export-confirm');
        const exportGroupToggle = document.getElementById('export-group-modality');
        const exportSectionToggle = document.getElementById('export-sectioned');
        const exportFields = Array.from(document.querySelectorAll('.export-field-toggle'));
        const exportSectionToggles = Array.from(document.querySelectorAll('.export-section-toggle'));
        const exportModalities = Array.from(document.querySelectorAll('.export-modality-toggle'));
        const exportModalitySelectAll = document.getElementById('export-modalities-all');
        const exportModalitySelectNone = document.getElementById('export-modalities-none');

        function summarizeCsaBlock(block) {
            const raw = block.getAttribute('data-csa');
            const hash = block.getAttribute('data-hash') || '';
            try {
                const parsed = raw ? JSON.parse(raw) : null;
                const elements = parsed && parsed.elements ? parsed.elements : {};
                const keys = Object.keys(elements);
                const elementCount = parsed && parsed.element_count ? parsed.element_count : keys.length;
                const asciiKeys = keys.filter((key) => /^[\\x20-\\x7E]+$/.test(key));
                const selected = [];
                for (const key of asciiKeys) {
                    const payload = elements[key];
                    const values = payload && payload.values ? payload.values : [];
                    if (values.length) {
                        selected.push(`${key}: ${values.slice(0, 2).join(', ')}`);
                    }
                    if (selected.length >= 8) {
                        break;
                    }
                }
                const keyPreview = keys.slice(0, 20).join(', ');
                const moreKeys = keys.length > 20 ? ` +${keys.length - 20}` : '';

                const table = document.createElement('table');
                table.style.width = '100%';
                table.style.borderCollapse = 'collapse';

                const rows = [
                    ['{{ t.element_count or "Element Count" }}', elementCount || '0'],
                    ['{{ t.key_list or "Key List" }}', keyPreview ? `${keyPreview}${moreKeys}` : '—'],
                    ['{{ t.protocol_fingerprint or "Protocol Fingerprint" }}', hash || '—'],
                    ['{{ t.ascii_keys or "Selected ASCII Keys" }}', selected.length ? selected.join('; ') : '—'],
                ];

                rows.forEach(([label, value]) => {
                    const tr = document.createElement('tr');
                    const th = document.createElement('th');
                    th.textContent = label;
                    th.style.textAlign = 'left';
                    th.style.padding = '4px 6px';
                    th.style.verticalAlign = 'top';
                    const td = document.createElement('td');
                    td.textContent = value;
                    td.style.padding = '4px 6px';
                    tr.appendChild(th);
                    tr.appendChild(td);
                    table.appendChild(tr);
                });

                block.appendChild(table);
            } catch (err) {
                if (hash) {
                    block.textContent = `{{ t.protocol_fingerprint or "Protocol Fingerprint" }}: ${hash}`;
                } else {
                    block.textContent = raw || '{{ t.no_data or "No data" }}';
                }
            }
        }

        document.querySelectorAll('.csa-summary').forEach(summarizeCsaBlock);

        function openExportModal() {
            if (!exportModal) {
                return;
            }
            exportModal.classList.add('open');
            exportModal.setAttribute('aria-hidden', 'false');
        }

        function closeExportModal() {
            if (!exportModal) {
                return;
            }
            exportModal.classList.remove('open');
            exportModal.setAttribute('aria-hidden', 'true');
        }

        function updateSectionState(sectionKey) {
            const sectionFields = exportFields.filter(field => field.dataset.section === sectionKey);
            const toggle = exportSectionToggles.find(field => field.dataset.exportSection === sectionKey);
            if (!toggle) {
                return;
            }
            const allChecked = sectionFields.every(field => field.checked);
            const anyChecked = sectionFields.some(field => field.checked);
            toggle.checked = allChecked;
            toggle.indeterminate = !allChecked && anyChecked;
        }

        if (exportOpenButton) {
            exportOpenButton.addEventListener('click', () => {
                openExportModal();
            });
        }

        exportCloseButtons.forEach(button => {
            button.addEventListener('click', closeExportModal);
        });

        if (exportModal) {
            exportModal.addEventListener('click', (event) => {
                if (event.target === exportModal) {
                    closeExportModal();
                }
            });
        }

        exportSectionToggles.forEach(toggle => {
            toggle.addEventListener('change', () => {
                const sectionKey = toggle.dataset.exportSection;
                exportFields
                    .filter(field => field.dataset.section === sectionKey)
                    .forEach(field => {
                        field.checked = toggle.checked;
                    });
                updateSectionState(sectionKey);
            });
        });

        exportFields.forEach(field => {
            field.addEventListener('change', () => {
                updateSectionState(field.dataset.section);
            });
        });

        exportSectionToggles.forEach(toggle => updateSectionState(toggle.dataset.exportSection));

        if (exportSelectAll) {
            exportSelectAll.addEventListener('click', () => {
                exportFields.forEach(field => { field.checked = true; });
                exportSectionToggles.forEach(toggle => updateSectionState(toggle.dataset.exportSection));
            });
        }

        if (exportSelectNone) {
            exportSelectNone.addEventListener('click', () => {
                exportFields.forEach(field => { field.checked = false; });
                exportSectionToggles.forEach(toggle => updateSectionState(toggle.dataset.exportSection));
            });
        }

        if (exportModalitySelectAll) {
            exportModalitySelectAll.addEventListener('click', () => {
                exportModalities.forEach(field => { field.checked = true; });
            });
        }

        if (exportModalitySelectNone) {
            exportModalitySelectNone.addEventListener('click', () => {
                exportModalities.forEach(field => { field.checked = false; });
            });
        }

        if (exportConfirm) {
            exportConfirm.addEventListener('click', () => {
                const selected = exportFields
                    .filter(field => field.checked)
                    .map(field => field.dataset.exportField);
                if (selected.length === 0) {
                    alert('{{ t.export_select_one }}');
                    return;
                }
                const params = new URLSearchParams();
                params.set('db', '{{ db_name }}');
                params.set('lang', '{{ lang }}');
                selected.forEach(field => params.append('fields', field));
                exportModalities
                    .filter(field => field.checked)
                    .map(field => field.dataset.exportModality)
                    .forEach(modality => params.append('modality', modality));
                if (exportSectionToggle && exportSectionToggle.checked) {
                    params.set('group', 'sectioned');
                } else if (exportGroupToggle && exportGroupToggle.checked) {
                    params.set('group', 'modality');
                }
                const url = `/study/{{ study_info.study_instance_uid }}/export.csv?${params.toString()}`;
                window.location.href = url;
                closeExportModal();
            });
        }
    </script>
</body>
</html>
