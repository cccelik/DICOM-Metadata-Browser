<!DOCTYPE html>
<html lang="{{ lang }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ t.dashboard_title or 'Analytics Dashboard' }} - DICOM Metadata Browser</title>
    <link rel="stylesheet" href="https://unpkg.com/@phosphor-icons/web@2.1.1/src/regular/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }
        
        body.dark {
            background: #0f141b;
            color: #e6edf3;
        }

        body.dark .protocol-adherence,
        body.dark .card,
        body.dark .distribution-info,
        body.dark .stat-box {
            background: #141c26;
            box-shadow: 0 2px 4px rgba(0,0,0,0.35);
        }

        body.dark .metric-label,
        body.dark h2,
        body.dark .stat-label,
        body.dark .stat-value,
        body.dark .metric-value,
        body.dark .distribution-info strong {
            color: #e6edf3;
        }

        body.dark table th {
            background: #1e2936;
            color: #e6edf3;
        }

        body.dark table th,
        body.dark table td {
            border-bottom-color: #243244;
        }


        body.dark .badge-primary {
            background: #2a62b8;
        }

        body.dark .progress-link .progress-fill {
            background: rgba(86, 173, 255, 0.25);
            color: #cfe0ff;
        }

        body.dark .progress-link:hover .progress-fill {
            background: rgba(86, 173, 255, 0.35);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .nav-links {
            margin-top: 15px;
        }
        
        .nav-links a {
            color: #3498db;
            text-decoration: none;
            margin-right: 20px;
            padding: 8px 16px;
            border-radius: 4px;
            transition: background 0.2s;
        }
        
        .nav-links a:hover {
            background: #ecf0f1;
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .card {
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .card h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 20px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        
        .stat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-box {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 28px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 12px;
            color: #7f8c8d;
            text-transform: uppercase;
        }
        
        .ideal-value {
            color: #27ae60;
        }
        
        .deviation {
            color: #e67e22;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
        }

        .chart-container.compact {
            height: 220px;
        }

        
        .protocol-adherence {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .protocol-adherence h2 {
            color: white;
            border-bottom: 2px solid rgba(255,255,255,0.3);
        }
        
        .adherence-metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }
        
        .adherence-metric:last-child {
            border-bottom: none;
        }
        
        .metric-label {
            font-size: 16px;
        }
        
        .metric-value {
            font-size: 24px;
            font-weight: bold;
        }
        
        .progress-bar {
            width: 100%;
            height: 30px;
            background: rgba(255,255,255,0.2);
            border-radius: 15px;
            overflow: hidden;
            margin-top: 10px;
        }
        
        .progress-fill {
            height: 100%;
            background: rgba(255,255,255,0.8);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #2c3e50;
            font-weight: bold;
            font-size: 12px;
        }

        .progress-link {
            display: block;
            height: 100%;
            text-decoration: none;
        }

        .progress-link .progress-fill {
            background: #e6f0ff;
            color: #1f4b99;
        }

        .progress-link:hover .progress-fill {
            background: #d6e7ff;
        }
        
        .distribution-info {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .distribution-info strong {
            color: #2c3e50;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        table th, table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
            overflow-wrap: anywhere;
            word-break: break-word;
        }
        
        table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .badge-primary {
            background: #3498db;
            color: white;
        }

        .card-title-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .card-title-row h2 {
            flex: 1;
        }

        .info-button {
            border: none;
            background: transparent;
            color: #5c6b84;
            cursor: pointer;
            padding: 4px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .info-button i {
            font-size: 18px;
        }

        body.dark .info-button {
            color: #9aa7b5;
        }

    </style>
    {% include "partials/top_bar/styles.html" %}
    {% include "partials/create_databank_styles.html" %}
</head>
<body>
    {% from "partials/top_bar/top_bar.html" import render_top_bar %}
    {% set lang_url_template = '/dashboard?db=' ~ db_name ~ '&lang=%s' %}
    {% set databank_url_template = '/dashboard?db=%s&lang=%s' %}
    {% call render_top_bar('top-dashboard-hamburger', 'top-dashboard-menu', (t.dashboard_title or 'Analytics Dashboard'), lang_url_template, databank_url_template, t, lang, db_name, databanks) %}
        <a href="/?db={{ db_name }}&lang={{ lang }}">{{ t.back_to_studies or 'Back to Studies' }}</a>
        <a href="/dashboard?db={{ db_name }}&lang={{ lang }}">{{ t.dashboard or 'Dashboard' }}</a>
    {% endcall %}
    <div class="container">
        <!-- Protocol Adherence Overview -->
        <div class="protocol-adherence">
            <h2>{{ t.protocol_adherence or 'Protocol Adherence' }}</h2>
            
            {% if stats.uptake_time.count > 0 %}
            <div class="adherence-metric">
                <div>
                    <div class="metric-label">{{ t.uptake_time_adherence or 'Uptake Time Adherence' }}</div>
                    <div style="font-size: 14px; opacity: 0.9; margin-top: 5px;">
                        {{ t.ideal_uptake_time or 'Ideal' }}: {{ stats.uptake_time.ideal }} {{ t.minutes or 'minutes' }} (±15 {{ t.minutes or 'minutes' }})
                    </div>
                </div>
                <div class="metric-value">
                    {{ "%.1f"|format((stats.uptake_time.within_ideal_range / stats.uptake_time.count * 100) if stats.uptake_time.count > 0 else 0) }}%
                </div>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" style="width: {{ (stats.uptake_time.within_ideal_range / stats.uptake_time.count * 100) if stats.uptake_time.count > 0 else 0 }}%">
                    {{ stats.uptake_time.within_ideal_range }} / {{ stats.uptake_time.count }} {{ t.series or 'series' }}
                </div>
            </div>
            {% endif %}
            
            {% if stats.dose_per_kg.count > 0 %}
            <div class="adherence-metric">
                <div>
                    <div class="metric-label">{{ t.dose_adherence or 'Dose per kg Adherence' }}</div>
                    <div style="font-size: 14px; opacity: 0.9; margin-top: 5px;">
                        {{ t.ideal_dose or 'Ideal' }}: {{ stats.dose_per_kg.ideal }} {{ t.mbq_kg or 'MBq/kg' }} (±0.5 {{ t.mbq_kg or 'MBq/kg' }})
                    </div>
                </div>
                <div class="metric-value">
                    {{ "%.1f"|format((stats.dose_per_kg.within_ideal_range / stats.dose_per_kg.count * 100) if stats.dose_per_kg.count > 0 else 0) }}%
                </div>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" style="width: {{ (stats.dose_per_kg.within_ideal_range / stats.dose_per_kg.count * 100) if stats.dose_per_kg.count > 0 else 0 }}%">
                    {{ stats.dose_per_kg.within_ideal_range }} / {{ stats.dose_per_kg.count }} {{ t.series or 'series' }}
                </div>
            </div>
            {% endif %}
        </div>

        
        <div class="dashboard-grid">
            <!-- Uptake Time Distribution -->
            {% if stats.uptake_time.count > 0 %}
            <div class="card">
                <div class="card-title-row">
                    <h2>{{ t.uptake_time_distribution or 'Injection-to-Scan Time Distribution' }}</h2>
                    <button class="info-button" type="button" aria-label="About injection-to-scan time distribution" title="About injection-to-scan time distribution" onclick="showInfoModal('uptake-time-modal')">
                        <i class="ph ph-info" aria-hidden="true"></i>
                    </button>
                </div>
                <div class="stat-grid">
                    <div class="stat-box">
                        <div class="stat-value ideal-value">{{ "%.1f"|format(stats.uptake_time.ideal) }}</div>
                        <div class="stat-label">{{ t.ideal_time or 'Ideal (min)' }}</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value">{{ "%.1f"|format(stats.uptake_time.mean) if stats.uptake_time.mean else 'N/A' }}</div>
                        <div class="stat-label">{{ t.mean or 'Mean (min)' }}</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value">{{ "%.1f"|format(stats.uptake_time.median) if stats.uptake_time.median else 'N/A' }}</div>
                        <div class="stat-label">{{ t.median or 'Median (min)' }}</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value">{{ "%.1f"|format(stats.uptake_time.std_dev) if stats.uptake_time.std_dev else 'N/A' }}</div>
                        <div class="stat-label">{{ t.std_dev or 'Std Dev' }}</div>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="uptakeTimeChart"></canvas>
                </div>
                <div class="distribution-info">
                    <strong>{{ t.range or 'Range' }}:</strong> 
                    {{ "%.1f"|format(stats.uptake_time.min) if stats.uptake_time.min else 'N/A' }} - 
                    {{ "%.1f"|format(stats.uptake_time.max) if stats.uptake_time.max else 'N/A' }} {{ t.minutes or 'minutes' }}<br>
                    <strong>{{ t.study_count or 'Study Count' }}:</strong> {{ stats.uptake_time.count }}
                </div>
            </div>
            {% endif %}
            
            <!-- Dose per kg Distribution -->
            {% if stats.dose_per_kg.count > 0 %}
            <div class="card">
                <div class="card-title-row">
                    <h2>{{ t.dose_distribution or 'Injected Dose per kg Distribution' }}</h2>
                    <button class="info-button" type="button" aria-label="About injected dose per kg distribution" title="About injected dose per kg distribution" onclick="showInfoModal('dose-distribution-modal')">
                        <i class="ph ph-info" aria-hidden="true"></i>
                    </button>
                </div>
                <div class="stat-grid">
                    <div class="stat-box">
                        <div class="stat-value ideal-value">{{ "%.1f"|format(stats.dose_per_kg.ideal) }}</div>
                        <div class="stat-label">{{ t.ideal_dose or 'Ideal (MBq/kg)' }}</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value">{{ "%.2f"|format(stats.dose_per_kg.mean) if stats.dose_per_kg.mean else 'N/A' }}</div>
                        <div class="stat-label">{{ t.mean or 'Mean (MBq/kg)' }}</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value">{{ "%.2f"|format(stats.dose_per_kg.median) if stats.dose_per_kg.median else 'N/A' }}</div>
                        <div class="stat-label">{{ t.median or 'Median (MBq/kg)' }}</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value">{{ "%.2f"|format(stats.dose_per_kg.std_dev) if stats.dose_per_kg.std_dev else 'N/A' }}</div>
                        <div class="stat-label">{{ t.std_dev or 'Std Dev' }}</div>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="doseChart"></canvas>
                </div>
                <div class="distribution-info">
                    <strong>{{ t.range or 'Range' }}:</strong> 
                    {{ "%.2f"|format(stats.dose_per_kg.min) if stats.dose_per_kg.min else 'N/A' }} - 
                    {{ "%.2f"|format(stats.dose_per_kg.max) if stats.dose_per_kg.max else 'N/A' }} {{ t.mbq_kg or 'MBq/kg' }}<br>
                    <strong>{{ t.study_count or 'Study Count' }}:</strong> {{ stats.dose_per_kg.count }}
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Additional Statistics -->
        <div class="dashboard-grid">
            <!-- Radiopharmaceuticals -->
            {% if stats.radiopharmaceuticals %}
            <div class="card">
                <div class="card-title-row">
                    <h2>{{ t.radiopharmaceuticals or 'Radiopharmaceuticals' }}</h2>
                    <button class="info-button" type="button" aria-label="About radiopharmaceutical counts" title="About radiopharmaceutical counts" onclick="showInfoModal('radiopharmaceuticals-modal')">
                        <i class="ph ph-info" aria-hidden="true"></i>
                    </button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>{{ t.radiopharmaceutical or 'Radiopharmaceutical' }}</th>
                            <th>{{ t.count or 'Count' }}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for rad, count in stats.radiopharmaceuticals.items() %}
                        <tr>
                            <td>{{ rad }}</td>
                            <td>{{ count }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% endif %}
            
            <!-- Manufacturers -->
            {% if stats.manufacturers %}
            <div class="card">
                <div class="card-title-row">
                    <h2>{{ t.manufacturers or 'Manufacturers' }}</h2>
                    <button class="info-button" type="button" aria-label="About manufacturer counts" title="About manufacturer counts" onclick="showInfoModal('manufacturers-modal')">
                        <i class="ph ph-info" aria-hidden="true"></i>
                    </button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>{{ t.manufacturer or 'Manufacturer' }}</th>
                            <th>{{ t.count or 'Count' }}</th>
                            <th>{{ t.percentage or 'Percentage' }}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for mfr, count in stats.manufacturers.items() %}
                        <tr>
                            <td>{{ mfr }}</td>
                            <td>{{ count }}</td>
                            <td>{{ "%.1f"|format((count / stats.total_series * 100) if stats.total_series > 0 else 0) }}%</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% endif %}
        </div>

        <div class="dashboard-grid">
            <div class="card">
                <div class="card-title-row">
                    <h2>{{ t.demographics or 'Demographics' }}</h2>
                    <button class="info-button" type="button" aria-label="About demographics" title="About demographics" onclick="showInfoModal('demographics-modal')">
                        <i class="ph ph-info" aria-hidden="true"></i>
                    </button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>{{ t.patient_sex or 'Sex' }}</th>
                            <th>{{ t.count or 'Count' }}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for sex, count in stats.sex_counts.items() %}
                        <tr>
                            <td>{{ sex }}</td>
                            <td>{{ count }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                <table>
                    <thead>
                        <tr>
                            <th>{{ t.age_bucket or 'Age Bucket' }}</th>
                            <th>{{ t.count or 'Count' }}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for bucket, count in stats.age_buckets.items() %}
                        <tr>
                            <td>{{ bucket }}</td>
                            <td>{{ count }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <div class="card">
                <div class="card-title-row">
                    <h2>{{ t.throughput or 'Throughput & Timing' }}</h2>
                    <button class="info-button" type="button" aria-label="About throughput and timing" title="About throughput and timing" onclick="showInfoModal('throughput-modal')">
                        <i class="ph ph-info" aria-hidden="true"></i>
                    </button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>{{ t.study_hour or 'Study Hour' }}</th>
                            <th>{{ t.count or 'Count' }}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for hour, count in stats.study_hours.items() %}
                        <tr>
                            <td>{{ "%02d"|format(hour) }}:00</td>
                            <td>{{ count }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- QA Dashboard -->
        <div class="dashboard-grid">
            <div class="card">
                <div class="card-title-row">
                    <h2>{{ t.metadata_completeness or 'Metadata Completeness' }}</h2>
                    <button class="info-button" type="button" aria-label="About metadata completeness" title="About metadata completeness" onclick="showInfoModal('metadata-completeness-modal')">
                        <i class="ph ph-info" aria-hidden="true"></i>
                    </button>
                </div>
                {% set total_series = completeness_stats.total %}
                {% set counts = completeness_stats.counts %}
                {% set totals = completeness_stats.totals if completeness_stats.totals else {} %}
                <div class="distribution-info">
                    <strong>{{ t.total_studies or 'Total studies' }}:</strong> {{ total_series }}
                </div>
                <div class="chart-container compact">
                    <canvas id="completenessChart"></canvas>
                </div>
                {% for key, label in [
                    ('weight', t.patient_weight or 'Weight'),
                    ('dose', t.injected_activity or 'Injected Activity'),
                    ('injection_time', t.injection_time or 'Injection Time'),
                    ('acquisition_time', t.acquisition_time or 'Acquisition Time'),
                    ('radiopharmaceutical', t.radiopharmaceutical or 'Radiopharmaceutical'),
                    ('patient_sex', t.patient_sex or 'Patient Sex'),
                    ('patient_age', t.patient_age or 'Patient Age')
                ] %}
                {% set count = counts[key] if counts and key in counts else 0 %}
                {% set denom = totals[key] if totals and key in totals else total_series %}
                {% set percent = (count / denom * 100) if denom else 0 %}
                <div class="adherence-metric">
                    <div>
                        <div class="metric-label">{{ label }}</div>
                        <div style="font-size: 14px; opacity: 0.9; margin-top: 5px;">
                            {{ count }} / {{ denom }} ({{ "%.1f"|format(percent) }}%)
                        </div>
                    </div>
                    <div class="metric-value">{{ "%.0f"|format(percent) }}%</div>
                </div>
                <div class="progress-bar">
                    <a class="progress-link" href="/?db={{ db_name }}&lang={{ lang }}&missing={{ key }}">
                        <div class="progress-fill" style="width: {{ percent }}%">
                            {{ t.view_missing or 'View missing' }}
                        </div>
                    </a>
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="dashboard-grid">
            <div class="card">
                <div class="card-title-row">
                    <h2>{{ t.timing_integrity or 'Timing Integrity' }}</h2>
                    <button class="info-button" type="button" aria-label="About timing integrity checks" title="About timing integrity checks" onclick="showInfoModal('timing-integrity-modal')">
                        <i class="ph ph-info" aria-hidden="true"></i>
                    </button>
                </div>
                <div class="chart-container compact">
                    <canvas id="timingIntegrityChart"></canvas>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>{{ t.check or 'Check' }}</th>
                            <th>{{ t.count or 'Count' }}</th>
                            <th>{{ t.action or 'Action' }}</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>{{ t.negative_uptake or 'Negative uptake times' }}</td>
                            <td>{{ timing_stats.negative }}</td>
                            <td><a href="/?db={{ db_name }}&lang={{ lang }}&timing_issue=negative">{{ t.view_studies or 'View studies' }}</a></td>
                        </tr>
                        <tr>
                            <td>{{ t.uptake_too_long or 'Uptake time > 240 min' }}</td>
                            <td>{{ timing_stats.too_long }}</td>
                            <td><a href="/?db={{ db_name }}&lang={{ lang }}&timing_issue=too_long">{{ t.view_studies or 'View studies' }}</a></td>
                        </tr>
                        <tr>
                            <td>{{ t.time_parse_fail or 'Timestamp parse failures' }}</td>
                            <td>{{ timing_stats.parse_fail }}</td>
                            <td><a href="/?db={{ db_name }}&lang={{ lang }}&timing_issue=parse_fail">{{ t.view_studies or 'View studies' }}</a></td>
                        </tr>
                        <tr>
                            <td>{{ t.study_time_conflict or 'Series time vs study time conflict' }}</td>
                            <td>{{ timing_stats.study_time_conflict }}</td>
                            <td><a href="/?db={{ db_name }}&lang={{ lang }}&timing_issue=study_time_conflict">{{ t.view_studies or 'View studies' }}</a></td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="card">
                <div class="card-title-row">
                    <h2>{{ t.dose_plausibility or 'Dose Plausibility' }}</h2>
                    <button class="info-button" type="button" aria-label="About dose plausibility checks" title="About dose plausibility checks" onclick="showInfoModal('dose-plausibility-modal')">
                        <i class="ph ph-info" aria-hidden="true"></i>
                    </button>
                </div>
                <div class="chart-container compact">
                    <canvas id="dosePlausibilityChart"></canvas>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>{{ t.check or 'Check' }}</th>
                            <th>{{ t.count or 'Count' }}</th>
                            <th>{{ t.action or 'Action' }}</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>{{ t.dose_outliers or 'Outliers (>3σ)' }}</td>
                            <td>{{ dose_stats.outliers }}</td>
                            <td><a href="/?db={{ db_name }}&lang={{ lang }}&dose_issue=outlier">{{ t.view_studies or 'View studies' }}</a></td>
                        </tr>
                        <tr>
                            <td>{{ t.unit_mismatch or 'Possible unit mismatch' }}</td>
                            <td>{{ dose_stats.unit_mismatch }}</td>
                            <td><a href="/?db={{ db_name }}&lang={{ lang }}&dose_issue=unit_mismatch">{{ t.view_studies or 'View studies' }}</a></td>
                        </tr>
                        <tr>
                            <td>{{ t.missing_activity_has_weight or 'Missing activity (weight present)' }}</td>
                            <td>{{ dose_stats.missing_activity_has_weight }}</td>
                            <td><a href="/?db={{ db_name }}&lang={{ lang }}&dose_issue=missing_activity">{{ t.view_studies or 'View studies' }}</a></td>
                        </tr>
                        <tr>
                            <td>{{ t.missing_weight_has_activity or 'Missing weight (activity present)' }}</td>
                            <td>{{ dose_stats.missing_weight_has_activity }}</td>
                            <td><a href="/?db={{ db_name }}&lang={{ lang }}&dose_issue=missing_weight">{{ t.view_studies or 'View studies' }}</a></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="dashboard-grid">
            <div class="card">
                <div class="card-title-row">
                    <h2>{{ t.scanner_landscape or 'Scanner Landscape' }}</h2>
                    <button class="info-button" type="button" aria-label="About scanner landscape" title="About scanner landscape" onclick="showInfoModal('scanner-landscape-modal')">
                        <i class="ph ph-info" aria-hidden="true"></i>
                    </button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>{{ t.manufacturer or 'Manufacturer' }}</th>
                            <th>{{ t.model or 'Model' }}</th>
                            <th>{{ t.software_version or 'Software' }}</th>
                            <th>{{ t.series or 'Series' }}</th>
                            <th>{{ t.unique_recon_fps or 'Unique CSA' }}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in scanner_landscape[:10] %}
                        <tr>
                            <td>{{ row.manufacturer }}</td>
                            <td>{{ row.model }}</td>
                            <td>{{ row.software }}</td>
                            <td>{{ row.count }}</td>
                            <td>{{ row.unique_csa }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <div class="card">
                <div class="card-title-row">
                    <h2>{{ t.protocol_radiopharm or 'Protocol × Radiopharmaceutical' }}</h2>
                    <button class="info-button" type="button" aria-label="About protocol and radiopharmaceutical summary" title="About protocol and radiopharmaceutical summary" onclick="showInfoModal('protocol-radiopharm-modal')">
                        <i class="ph ph-info" aria-hidden="true"></i>
                    </button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>{{ t.radiopharmaceutical or 'Radiopharmaceutical' }}</th>
                            <th>{{ t.unique_recon_fps or 'Unique CSA' }}</th>
                            <th>{{ t.top_fingerprint or 'Top fingerprint' }}</th>
                            <th>{{ t.count or 'Count' }}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in protocol_radiopharm[:10] %}
                        <tr>
                            <td>{{ row.radiopharmaceutical }}</td>
                            <td>{{ row.unique_fps }}</td>
                            <td>{{ row.top_fp }}</td>
                            <td>{{ row.top_count }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="dashboard-grid">
            <div class="card">
                <div class="card-title-row">
                    <h2>{{ t.derived_objects_qa or 'Derived Objects QA' }}</h2>
                    <button class="info-button" type="button" aria-label="About derived objects QA" title="About derived objects QA" onclick="showInfoModal('derived-objects-modal')">
                        <i class="ph ph-info" aria-hidden="true"></i>
                    </button>
                </div>
                <div class="stat-grid">
                    <div class="stat-box">
                        <div class="stat-value">{{ derived_stats.seg }}</div>
                        <div class="stat-label">SEG</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value">{{ derived_stats.rtstruct }}</div>
                        <div class="stat-label">RTSTRUCT</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value">{{ derived_stats.highdicom }}</div>
                        <div class="stat-label">highdicom</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value">{{ derived_stats.qiicr }}</div>
                        <div class="stat-label">QIICR</div>
                    </div>
                </div>
                {% if derived_stats.ctp_labels and derived_stats.ctp_labels|length %}
                <table>
                    <thead>
                        <tr>
                            <th>{{ t.ctp_label or 'CTP Label' }}</th>
                            <th>{{ t.count or 'Count' }}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in derived_stats.ctp_labels %}
                        <tr>
                            <td>{{ row.value_text }}</td>
                            <td>{{ row.count }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% endif %}
            </div>

            <div class="card">
                <div class="card-title-row">
                    <h2>{{ t.duplicates_or_collisions or 'Duplicates & Collisions' }}</h2>
                    <button class="info-button" type="button" aria-label="About duplicates and collisions" title="About duplicates and collisions" onclick="showInfoModal('duplicates-collisions-modal')">
                        <i class="ph ph-info" aria-hidden="true"></i>
                    </button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>{{ t.check or 'Check' }}</th>
                            <th>{{ t.count or 'Count' }}</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>{{ t.duplicate_sop or 'Duplicate SOPInstanceUID' }}</td>
                            <td>{{ duplicate_stats.duplicate_sop }}</td>
                        </tr>
                        <tr>
                            <td>{{ t.duplicate_series_signatures or 'Duplicate series signatures' }}</td>
                            <td>{{ duplicate_stats.duplicate_series_signatures }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="dashboard-grid">
            <div class="card">
                <div class="card-title-row">
                    <h2>{{ t.study_composition or 'Study Composition' }}</h2>
                    <button class="info-button" type="button" aria-label="About study composition checks" title="About study composition checks" onclick="showInfoModal('study-composition-modal')">
                        <i class="ph ph-info" aria-hidden="true"></i>
                    </button>
                </div>
                <div class="chart-container compact">
                    <canvas id="studyCompositionChart"></canvas>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>{{ t.check or 'Check' }}</th>
                            <th>{{ t.count or 'Count' }}</th>
                            <th>{{ t.action or 'Action' }}</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>{{ t.missing_ct or 'Studies missing CT' }}</td>
                            <td>{{ study_comp_stats.missing_ct }}</td>
                            <td><a href="/?db={{ db_name }}&lang={{ lang }}&composition=missing_ct">{{ t.view_studies or 'View studies' }}</a></td>
                        </tr>
                        <tr>
                            <td>{{ t.missing_pt or 'Studies missing PT' }}</td>
                            <td>{{ study_comp_stats.missing_pt }}</td>
                            <td><a href="/?db={{ db_name }}&lang={{ lang }}&composition=missing_pt">{{ t.view_studies or 'View studies' }}</a></td>
                        </tr>
                        <tr>
                            <td>{{ t.high_series_count or 'Studies with >20 series' }}</td>
                            <td>{{ study_comp_stats.high_series }}</td>
                            <td><a href="/?db={{ db_name }}&lang={{ lang }}&composition=high_series">{{ t.view_studies or 'View studies' }}</a></td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="card">
                <div class="card-title-row">
                    <h2>{{ t.qa_score_distribution or 'QA Score Distribution' }}</h2>
                    <button class="info-button" type="button" aria-label="{{ t.qa_score_help or 'QA score help' }}" title="{{ t.qa_score_help or 'QA score help' }}" onclick="showQaScoreHelp()">
                        <i class="ph ph-info" aria-hidden="true"></i>
                    </button>
                </div>
                <div class="chart-container compact">
                    <canvas id="qaScoreChart"></canvas>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>{{ t.qa_score or 'QA Score' }}</th>
                            <th>{{ t.count or 'Count' }}</th>
                            <th>{{ t.action or 'Action' }}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for score in range(0, 6) %}
                        <tr>
                            <td>{{ score }}</td>
                            <td>{{ qa_scores[score] }}</td>
                            <td><a href="/?db={{ db_name }}&lang={{ lang }}&qa_score={{ score }}">{{ t.view_studies or 'View studies' }}</a></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    {% from "partials/modals/modal.html" import modal_wrapper %}
    {% call modal_wrapper("qa-score-modal", t.qa_score_distribution or 'QA Score Distribution') %}
        <p>{{ t.qa_score_help or 'QA (Quality Assurance) score is 0-5 based on the representative series:' }}</p>
        <ul>
            <li>{{ t.patient_weight or 'Patient weight' }}: {{ t.present or 'present' }}</li>
            <li>{{ t.injected_activity or 'Injected activity' }}: {{ t.present or 'present' }}</li>
            <li>{{ t.uptake_time_adherence or 'Uptake time' }}: {{ t.ok_or_too_long or 'status ok or too_long' }}</li>
            <li>{{ t.timing_integrity or 'Timing integrity' }}: {{ t.no_time_conflict or 'status ok and no time conflict' }}</li>
            <li>{{ t.recon_consistency or 'CSA fingerprint' }}: {{ t.matches_majority or 'matches majority fingerprint' }}</li>
        </ul>
        <div class="modal-actions">
            <button class="modal-close" type="button" onclick="closeQaScoreHelp()">
                {{ t.close or 'Close' }}
            </button>
        </div>
    {% endcall %}

    {% call modal_wrapper("uptake-time-modal", t.uptake_time_distribution or 'Injection-to-Scan Time Distribution') %}
        <p>Histogram of injection-to-scan time (minutes) computed from injection and acquisition timestamps on the representative series.</p>
        <ul>
            <li>Bins are clickable to filter studies in the main list.</li>
            <li>Ideal/mean/median/std dev are shown above the chart.</li>
        </ul>
        <div class="modal-actions">
            <button class="modal-close" type="button" onclick="closeInfoModal('uptake-time-modal')">
                {{ t.close or 'Close' }}
            </button>
        </div>
    {% endcall %}

    {% call modal_wrapper("dose-distribution-modal", t.dose_distribution or 'Injected Dose per kg Distribution') %}
        <p>Histogram of injected activity per kg (MBq/kg) computed from injected activity and patient weight on the representative series.</p>
        <ul>
            <li>Bins are clickable to filter studies in the main list.</li>
            <li>Ideal/mean/median/std dev are shown above the chart.</li>
        </ul>
        <div class="modal-actions">
            <button class="modal-close" type="button" onclick="closeInfoModal('dose-distribution-modal')">
                {{ t.close or 'Close' }}
            </button>
        </div>
    {% endcall %}

    {% call modal_wrapper("radiopharmaceuticals-modal", t.radiopharmaceuticals or 'Radiopharmaceuticals') %}
        <p>Counts of radiopharmaceutical names across series with a recorded value.</p>
        <div class="modal-actions">
            <button class="modal-close" type="button" onclick="closeInfoModal('radiopharmaceuticals-modal')">
                {{ t.close or 'Close' }}
            </button>
        </div>
    {% endcall %}

    {% call modal_wrapper("manufacturers-modal", t.manufacturers or 'Manufacturers') %}
        <p>Series counts by manufacturer with percentages of total series.</p>
        <div class="modal-actions">
            <button class="modal-close" type="button" onclick="closeInfoModal('manufacturers-modal')">
                {{ t.close or 'Close' }}
            </button>
        </div>
    {% endcall %}

    {% call modal_wrapper("demographics-modal", t.demographics or 'Demographics') %}
        <p>Patient sex and age buckets derived from available patient metadata.</p>
        <div class="modal-actions">
            <button class="modal-close" type="button" onclick="closeInfoModal('demographics-modal')">
                {{ t.close or 'Close' }}
            </button>
        </div>
    {% endcall %}

    {% call modal_wrapper("throughput-modal", t.throughput or 'Throughput & Timing') %}
        <p>Study counts by Study Time hour to show daily throughput patterns.</p>
        <div class="modal-actions">
            <button class="modal-close" type="button" onclick="closeInfoModal('throughput-modal')">
                {{ t.close or 'Close' }}
            </button>
        </div>
    {% endcall %}

    {% call modal_wrapper("metadata-completeness-modal", t.metadata_completeness or 'Metadata Completeness') %}
        <p>Percent of studies with key fields present on the representative series. Use "View missing" to filter.</p>
        <div class="modal-actions">
            <button class="modal-close" type="button" onclick="closeInfoModal('metadata-completeness-modal')">
                {{ t.close or 'Close' }}
            </button>
        </div>
    {% endcall %}

    {% call modal_wrapper("timing-integrity-modal", t.timing_integrity or 'Timing Integrity') %}
        <p>QA checks on injection/acquisition timing and timestamp parsing.</p>
        <ul>
            <li>Negative uptake time.</li>
            <li>Uptake time &gt; 240 minutes.</li>
            <li>Timestamp parse failures.</li>
            <li>Study vs series time gap &gt; 120 minutes.</li>
        </ul>
        <div class="modal-actions">
            <button class="modal-close" type="button" onclick="closeInfoModal('timing-integrity-modal')">
                {{ t.close or 'Close' }}
            </button>
        </div>
    {% endcall %}

    {% call modal_wrapper("dose-plausibility-modal", t.dose_plausibility or 'Dose Plausibility') %}
        <p>QA checks on injected dose values for radiopharmaceutical studies.</p>
        <ul>
            <li>Outliers &gt; 3 sigma based on MBq/kg.</li>
            <li>Possible unit mismatch when MBq/kg is extreme.</li>
            <li>Missing activity or weight when the other is present.</li>
        </ul>
        <div class="modal-actions">
            <button class="modal-close" type="button" onclick="closeInfoModal('dose-plausibility-modal')">
                {{ t.close or 'Close' }}
            </button>
        </div>
    {% endcall %}

    {% call modal_wrapper("scanner-landscape-modal", t.scanner_landscape or 'Scanner Landscape') %}
        <p>Top scanner configurations by manufacturer/model/software with series counts and unique CSA fingerprints.</p>
        <div class="modal-actions">
            <button class="modal-close" type="button" onclick="closeInfoModal('scanner-landscape-modal')">
                {{ t.close or 'Close' }}
            </button>
        </div>
    {% endcall %}

    {% call modal_wrapper("protocol-radiopharm-modal", t.protocol_radiopharm or 'Protocol × Radiopharmaceutical') %}
        <p>Top protocol and radiopharmaceutical combinations with unique CSA fingerprints and counts.</p>
        <div class="modal-actions">
            <button class="modal-close" type="button" onclick="closeInfoModal('protocol-radiopharm-modal')">
                {{ t.close or 'Close' }}
            </button>
        </div>
    {% endcall %}

    {% call modal_wrapper("derived-objects-modal", t.derived_objects_qa or 'Derived Objects QA') %}
        <p>Counts of derived objects (SEG, RTSTRUCT, highdicom, QIICR) plus any CTP labels.</p>
        <div class="modal-actions">
            <button class="modal-close" type="button" onclick="closeInfoModal('derived-objects-modal')">
                {{ t.close or 'Close' }}
            </button>
        </div>
    {% endcall %}

    {% call modal_wrapper("duplicates-collisions-modal", t.duplicates_or_collisions or 'Duplicates & Collisions') %}
        <p>Potential duplicates detected by matching SOPInstanceUIDs or series signature hashes.</p>
        <div class="modal-actions">
            <button class="modal-close" type="button" onclick="closeInfoModal('duplicates-collisions-modal')">
                {{ t.close or 'Close' }}
            </button>
        </div>
    {% endcall %}

    {% call modal_wrapper("study-composition-modal", t.study_composition or 'Study Composition') %}
        <p>Counts of studies missing CT/PT modalities or having more than 20 series.</p>
        <div class="modal-actions">
            <button class="modal-close" type="button" onclick="closeInfoModal('study-composition-modal')">
                {{ t.close or 'Close' }}
            </button>
        </div>
    {% endcall %}

    {% include "partials/create_databank_modal.html" %}

    {% set menu_button_id = 'top-dashboard-hamburger' %}
    {% set menu_id = 'top-dashboard-menu' %}
    {% set reload_on_theme_change = true %}
    {% include "partials/top_bar/scripts.html" %}
    
    <script>
        {% include "partials/charts/helpers.html" %}

        function showQaScoreHelp() {
            const modal = document.getElementById('qa-score-modal');
            if (!modal) {
                return;
            }
            modal.classList.add('active');
            modal.setAttribute('aria-hidden', 'false');
        }

        function closeQaScoreHelp() {
            const modal = document.getElementById('qa-score-modal');
            if (!modal) {
                return;
            }
            modal.classList.remove('active');
            modal.setAttribute('aria-hidden', 'true');
        }

        function showInfoModal(modalId) {
            const modal = document.getElementById(modalId);
            if (!modal) {
                return;
            }
            modal.classList.add('active');
            modal.setAttribute('aria-hidden', 'false');
        }

        function closeInfoModal(modalId) {
            const modal = document.getElementById(modalId);
            if (!modal) {
                return;
            }
            modal.classList.remove('active');
            modal.setAttribute('aria-hidden', 'true');
        }

        // Uptake Time Chart
        {% if stats.uptake_time.count > 0 %}
        const uptakeCtx = document.getElementById('uptakeTimeChart').getContext('2d');
        const uptakeLabels = {{ uptake_histogram['labels']|tojson }};
        const uptakeValues = {{ uptake_histogram['values']|tojson }};
        new Chart(uptakeCtx, {
            type: 'bar',
            data: {
                labels: uptakeLabels,
                datasets: [{
                    label: '{{ t.study_count or "Study Count" }}',
                    data: uptakeValues,
                    backgroundColor: chartTheme.blueFill,
                    borderColor: chartTheme.blueBorder,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            color: chartTheme.text
                        },
                        grid: {
                            color: chartTheme.grid
                        },
                        title: {
                            display: true,
                            text: '{{ t.study_count or "Study Count" }}',
                            color: chartTheme.text
                        }
                    },
                    x: {
                        ticks: {
                            color: chartTheme.text
                        },
                        grid: {
                            color: chartTheme.grid
                        },
                        title: {
                            display: true,
                            text: '{{ t.uptake_time_minutes or "Uptake Time (minutes)" }}',
                            color: chartTheme.text
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        labels: {
                            color: chartTheme.text
                        }
                    },
                    tooltip: {
                        backgroundColor: chartTheme.tooltipBg,
                        titleColor: chartTheme.tooltipText,
                        bodyColor: chartTheme.tooltipText,
                        callbacks: {
                            title: function() {
                                return '';
                            },
                            label: function(context) {
                                const labels = context.chart.data.labels;
                                const width = getBinWidth(labels);
                                const start = parseFloat(labels[context.dataIndex]);
                                if (width !== null && !Number.isNaN(start)) {
                                    const end = start + width;
                                    const startLabel = formatWithPrecision(start, labels);
                                    const endLabel = formatWithPrecision(end, labels);
                                    const studyCount = context.parsed.y ?? 0;
                                    return [
                                        `range ${startLabel}-${endLabel}`,
                                        `Study Count: ${studyCount}`
                                    ];
                                }
                                return '';
                            }
                        }
                    }
                },
                onClick: (event, elements, chart) => {
                    if (!elements.length) {
                        return;
                    }
                    const index = elements[0].index;
                    const labels = chart.data.labels;
                    const width = getBinWidth(labels);
                    const start = parseFloat(labels[index]);
                    if (width === null || Number.isNaN(start)) {
                        return;
                    }
                    const end = start + width;
                    window.location.href = buildIndexUrl({
                        uptake_min: formatWithPrecision(start, labels),
                        uptake_max: formatWithPrecision(end, labels)
                    });
                }
            }
        });
        {% endif %}
        
        // Dose per kg Chart
        {% if stats.dose_per_kg.count > 0 %}
        const doseCtx = document.getElementById('doseChart').getContext('2d');
        const doseLabels = {{ dose_histogram['labels']|tojson }};
        const doseValues = {{ dose_histogram['values']|tojson }};
        new Chart(doseCtx, {
            type: 'bar',
            data: {
                labels: doseLabels,
                datasets: [{
                    label: '{{ t.study_count or "Study Count" }}',
                    data: doseValues,
                    backgroundColor: chartTheme.orangeFill,
                    borderColor: chartTheme.orangeBorder,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            color: chartTheme.text
                        },
                        grid: {
                            color: chartTheme.grid
                        },
                        title: {
                            display: true,
                            text: '{{ t.study_count or "Study Count" }}',
                            color: chartTheme.text
                        }
                    },
                    x: {
                        ticks: {
                            color: chartTheme.text
                        },
                        grid: {
                            color: chartTheme.grid
                        },
                        title: {
                            display: true,
                            text: '{{ t.dose_mbq_kg or "Dose (MBq/kg)" }}',
                            color: chartTheme.text
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        labels: {
                            color: chartTheme.text
                        }
                    },
                    tooltip: {
                        backgroundColor: chartTheme.tooltipBg,
                        titleColor: chartTheme.tooltipText,
                        bodyColor: chartTheme.tooltipText,
                        callbacks: {
                            title: function() {
                                return '';
                            },
                            label: function(context) {
                                const labels = context.chart.data.labels;
                                const width = getBinWidth(labels);
                                const start = parseFloat(labels[context.dataIndex]);
                                if (width !== null && !Number.isNaN(start)) {
                                    const end = start + width;
                                    const startLabel = formatWithPrecision(start, labels);
                                    const endLabel = formatWithPrecision(end, labels);
                                    const studyCount = context.parsed.y ?? 0;
                                    return [
                                        `range ${startLabel}-${endLabel}`,
                                        `Study Count: ${studyCount}`
                                    ];
                                }
                                return '';
                            }
                        }
                    }
                },
                onClick: (event, elements, chart) => {
                    if (!elements.length) {
                        return;
                    }
                    const index = elements[0].index;
                    const labels = chart.data.labels;
                    const width = getBinWidth(labels);
                    const start = parseFloat(labels[index]);
                    if (width === null || Number.isNaN(start)) {
                        return;
                    }
                    const end = start + width;
                    window.location.href = buildIndexUrl({
                        dose_min: formatWithPrecision(start, labels),
                        dose_max: formatWithPrecision(end, labels)
                    });
                }
            }
        });
        {% endif %}

        const completenessChartEl = document.getElementById('completenessChart');
        if (completenessChartEl) {
            const completenessLabels = [
                '{{ t.patient_weight or "Weight" }}',
                '{{ t.injected_activity or "Injected Activity" }}',
                '{{ t.injection_time or "Injection Time" }}',
                '{{ t.acquisition_time or "Acquisition Time" }}',
                '{{ t.radiopharmaceutical or "Radiopharmaceutical" }}',
                '{{ t.patient_sex or "Patient Sex" }}',
                '{{ t.patient_age or "Patient Age" }}'
            ];
            const completenessCounts = [
                {{ counts.weight if counts and "weight" in counts else 0 }},
                {{ counts.dose if counts and "dose" in counts else 0 }},
                {{ counts.injection_time if counts and "injection_time" in counts else 0 }},
                {{ counts.acquisition_time if counts and "acquisition_time" in counts else 0 }},
                {{ counts.radiopharmaceutical if counts and "radiopharmaceutical" in counts else 0 }},
                {{ counts.patient_sex if counts and "patient_sex" in counts else 0 }},
                {{ counts.patient_age if counts and "patient_age" in counts else 0 }}
            ];
            const completenessDenoms = [
                {{ totals.get('weight', total_series) }},
                {{ totals.get('dose', total_series) }},
                {{ totals.get('injection_time', total_series) }},
                {{ totals.get('acquisition_time', total_series) }},
                {{ totals.get('radiopharmaceutical', total_series) }},
                {{ totals.get('patient_sex', total_series) }},
                {{ totals.get('patient_age', total_series) }}
            ];
            const completenessValues = completenessCounts.map((count, idx) => {
                const denom = completenessDenoms[idx] || 0;
                return denom ? (count / denom * 100) : 0;
            });
            createBarChart(completenessChartEl.getContext('2d'), completenessLabels, completenessValues, {
                fill: chartTheme.blueFill,
                border: chartTheme.blueBorder,
                yTitle: '{{ t.percent or "Percent" }}'
            });
        }

        const timingChartEl = document.getElementById('timingIntegrityChart');
        if (timingChartEl) {
            const timingLabels = [
                '{{ t.negative_uptake or "Negative uptake times" }}',
                '{{ (t.uptake_too_long or "Uptake time > 240 min")|safe }}',
                '{{ t.time_parse_fail or "Timestamp parse failures" }}',
                '{{ t.study_time_conflict or "Series time vs study time conflict" }}'
            ];
            const timingValues = [
                {{ timing_stats.negative }},
                {{ timing_stats.too_long }},
                {{ timing_stats.parse_fail }},
                {{ timing_stats.study_time_conflict }}
            ];
            createBarChart(timingChartEl.getContext('2d'), timingLabels, timingValues, {
                fill: chartTheme.orangeFill,
                border: chartTheme.orangeBorder,
                yTitle: '{{ t.count or "Count" }}'
            });
        }

        const dosePlausibilityChartEl = document.getElementById('dosePlausibilityChart');
        if (dosePlausibilityChartEl) {
            const doseLabels = [
                '{{ (t.dose_outliers or "Outliers (>3σ)")|safe }}',
                '{{ t.unit_mismatch or "Possible unit mismatch" }}',
                '{{ t.missing_activity_has_weight or "Missing activity (weight present)" }}',
                '{{ t.missing_weight_has_activity or "Missing weight (activity present)" }}'
            ];
            const doseValues = [
                {{ dose_stats.outliers }},
                {{ dose_stats.unit_mismatch }},
                {{ dose_stats.missing_activity_has_weight }},
                {{ dose_stats.missing_weight_has_activity }}
            ];
            createBarChart(dosePlausibilityChartEl.getContext('2d'), doseLabels, doseValues, {
                fill: chartTheme.orangeFill,
                border: chartTheme.orangeBorder,
                yTitle: '{{ t.count or "Count" }}'
            });
        }

        const compositionChartEl = document.getElementById('studyCompositionChart');
        if (compositionChartEl) {
            const compositionLabels = [
                '{{ t.missing_ct or "Studies missing CT" }}',
                '{{ t.missing_pt or "Studies missing PT" }}',
                '{{ (t.high_series_count or "Studies with >20 series")|safe }}'
            ];
            const compositionValues = [
                {{ study_comp_stats.missing_ct }},
                {{ study_comp_stats.missing_pt }},
                {{ study_comp_stats.high_series }}
            ];
            createBarChart(compositionChartEl.getContext('2d'), compositionLabels, compositionValues, {
                fill: chartTheme.blueFill,
                border: chartTheme.blueBorder,
                yTitle: '{{ t.count or "Count" }}'
            });
        }

        const qaScoreChartEl = document.getElementById('qaScoreChart');
        if (qaScoreChartEl) {
            const qaLabels = ['0', '1', '2', '3', '4', '5'];
            const qaValues = [
                {{ qa_scores[0] }},
                {{ qa_scores[1] }},
                {{ qa_scores[2] }},
                {{ qa_scores[3] }},
                {{ qa_scores[4] }},
                {{ qa_scores[5] }}
            ];
            createBarChart(qaScoreChartEl.getContext('2d'), qaLabels, qaValues, {
                fill: chartTheme.greenLine,
                border: chartTheme.greenLine,
                yTitle: '{{ t.count or "Count" }}'
            });
        }
    </script>
    <script>
        const qaScoreModal = document.getElementById('qa-score-modal');

        if (qaScoreModal) {
            qaScoreModal.addEventListener('click', (event) => {
                if (event.target === qaScoreModal) {
                    closeQaScoreHelp();
                }
            });
        }

        const infoModalIds = [
            'uptake-time-modal',
            'dose-distribution-modal',
            'radiopharmaceuticals-modal',
            'manufacturers-modal',
            'demographics-modal',
            'throughput-modal',
            'metadata-completeness-modal',
            'timing-integrity-modal',
            'dose-plausibility-modal',
            'scanner-landscape-modal',
            'protocol-radiopharm-modal',
            'derived-objects-modal',
            'duplicates-collisions-modal',
            'study-composition-modal'
        ];

        infoModalIds.forEach((modalId) => {
            const modal = document.getElementById(modalId);
            if (!modal) {
                return;
            }
            modal.addEventListener('click', (event) => {
                if (event.target === modal) {
                    closeInfoModal(modalId);
                }
            });
        });
    </script>
    {% include "partials/create_databank_script.html" %}
</body>
</html>
