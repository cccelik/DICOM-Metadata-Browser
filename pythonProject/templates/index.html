<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DICOM Metadata Browser</title>
    <link rel="stylesheet" href="https://unpkg.com/@phosphor-icons/web@2.1.1/src/regular/style.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #7f8c8d;
            font-size: 14px;
        }
        
        .error {
            background: #fee;
            border: 1px solid #fcc;
            color: #c00;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
        }
        
        .studies-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .study-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }
        
        .study-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .study-card h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 18px;
            overflow-wrap: anywhere;
            word-break: break-word;
        }
        
        .study-info {
            display: grid;
            gap: 8px;
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            gap: 12px;
        }
        
        .info-label {
            color: #7f8c8d;
            font-weight: 500;
            flex: 0 0 auto;
        }
        
        .info-value {
            color: #2c3e50;
            flex: 1 1 auto;
            min-width: 0;
            text-align: right;
            overflow-wrap: anywhere;
            word-break: break-word;
        }

        .badge-row {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .badge {
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .badge-modality {
            background: #e3f2fd;
            color: #1976d2;
        }
        
        .badge-manufacturer {
            background: #f3e5f5;
            color: #7b1fa2;
        }
        
        .series-count {
            background: #e8f5e9;
            color: #388e3c;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #7f8c8d;
        }
        
        .empty-state h2 {
            margin-bottom: 10px;
            color: #95a5a6;
        }
        
        a {
            text-decoration: none;
            color: inherit;
        }
        .lang-toggle {
            padding: 6px 12px;
            text-decoration: none;
            border-radius: 4px;
            font-size: 14px;
            color: #7f8c8d;
            font-weight: 400;
        }

        .lang-toggle.active {
            background: #3498db;
            color: white;
            font-weight: 500;
        }

        .top-bar {
            width: 100%;
            background: #fff;
            border-bottom: 4px solid #4e85e9;
            color: #0c2e49;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
        }

        .top-bar-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .top-bar-copy {
            display: flex;
            flex-direction: column;
            line-height: 1.2;
        }

        .top-bar-copy span,
        .top-bar-copy strong {
            font-size: 16px;
            font-weight: 400;
        }

        .top-bar-center {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            flex: 1;
            text-align: center;
        }

        .top-bar-center .title-main {
            font-size: 20px;
            font-weight: 600;
            color: #0c2e49;
        }

        .top-bar-center .title-sub {
            font-size: 14px;
            font-weight: 400;
            color: #5c6b84;
        }

        .top-bar-right {
            font-size: 13px;
            text-align: right;
            line-height: 1.3;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 4px;
        }

        .top-bar-right img {
            height: 100px;
        }

        .hamburger-wrapper {
            position: relative;
            display: inline-flex;
            align-items: center;
        }

        .hamburger-button {
            width: 38px;
            height: 38px;
            border-radius: 8px;
            border: 1px solid rgba(0, 0, 0, 0.2);
            background: transparent;
            cursor: pointer;
            display: inline-flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 6px;
            padding: 0;
        }

        .hamburger-button span {
            display: block;
            width: 20px;
            height: 2px;
            background: #0c2e49;
            border-radius: 4px;
        }

        .hamburger-menu {
            position: absolute;
            top: 48px;
            left: 0;
            background: white;
            color: #0c2e49;
            border-radius: 8px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            min-width: 180px;
            transform-origin: top left;
            transform: scale(0.95);
            opacity: 0;
            pointer-events: none;
            transition: all 0.2s ease;
            z-index: 10;
        }

        .hamburger-menu.open {
            transform: scale(1);
            opacity: 1;
            pointer-events: auto;
        }

        .hamburger-menu a,
        .hamburger-menu button {
            display: block;
            padding: 12px 16px;
            border-bottom: 1px solid #f0f0f0;
            color: inherit;
            font-size: 14px;
            text-decoration: none;
            background: transparent;
            border: none;
            text-align: left;
            width: 100%;
            cursor: pointer;
        }

        .hamburger-lang {
            display: flex;
            gap: 6px;
            padding: 8px 16px;
            justify-content: space-between;
        }

        .theme-toggle {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .theme-toggle i {
            font-size: 18px;
            line-height: 1;
        }

        .panel {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .databank-item {
            display: inline-flex;
            align-items: center;
            padding: 8px 14px;
            border-radius: 999px;
            border: 1px solid #d7dde4;
            background: #f8f9fb;
            font-size: 13px;
            color: #2c3e50;
            transition: all 0.2s ease;
        }

        .databank-item:hover {
            border-color: #4e85e9;
            color: #1f4b99;
            background: #eef4ff;
        }

        .databank-item.active {
            background: #0c2e49;
            border-color: #0c2e49;
            color: #fff;
        }

        body.dark {
            background: #0f141b;
            color: #e6edf3;
        }

        body.dark header,
        body.dark .study-card,
        body.dark .panel {
            background: #141c26;
            box-shadow: 0 2px 4px rgba(0,0,0,0.35);
        }

        body.dark .top-bar {
            background: #121a24;
            border-bottom-color: #2a3b52;
            color: #e6edf3;
        }

        body.dark .top-bar-center .title-main,
        body.dark .top-bar-copy span,
        body.dark .top-bar-copy strong {
            color: #e6edf3;
        }

        body.dark .top-bar-center .title-sub {
            color: #9aa7b5;
        }

        body.dark .top-bar-right img {
            filter: brightness(1.6) contrast(1.1);
        }

        body.dark .hamburger-button {
            border-color: #2a3b52;
        }

        body.dark .hamburger-button span {
            background: #e6edf3;
        }

        body.dark .hamburger-menu {
            background: #18212d;
            color: #e6edf3;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
        }

        body.dark .hamburger-menu a,
        body.dark .hamburger-menu button {
            border-bottom: 1px solid #243244;
        }

        body.dark .lang-toggle {
            color: #9aa7b5;
        }

        body.dark .lang-toggle.active {
            background: #2a62b8;
            color: #fff;
        }

        body.dark .study-card h3,
        body.dark .info-value {
            color: #e6edf3;
        }

        body.dark .info-label,
        body.dark .subtitle,
        body.dark .empty-state {
            color: #9aa7b5;
        }

        body.dark .error {
            background: #3a1f1f;
            border-color: #6b2d2d;
            color: #f2caca;
        }

        body.dark .badge-modality {
            background: #1f3248;
            color: #90c2ff;
        }

        body.dark .badge-manufacturer {
            background: #30203b;
            color: #d1a4ff;
        }

        body.dark .series-count {
            background: #1f3b2a;
            color: #9fe3b6;
        }

        body.dark input[type="text"],
        body.dark input[type="number"] {
            background: #0f141b;
            color: #e6edf3;
            border-color: #2a3b52;
        }

        body.dark input[type="text"]::placeholder {
            color: #7f8c8d;
        }

        body.dark input[type="number"]::placeholder {
            color: #7f8c8d;
        }

        .filter-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 10px;
            margin-top: 12px;
        }

        .filter-row input {
            padding: 10px 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .filter-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .filter-toggle {
            padding: 12px 18px;
            background: #ecf0f1;
            color: #2c3e50;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            font-weight: 500;
        }

        .filter-panel {
            margin-top: 12px;
            display: none;
        }

        .filter-panel.open {
            display: block;
        }

        body.dark .filter-toggle {
            background: #1e2936;
            color: #e6edf3;
        }

        .modality-filters {
            margin-top: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .modality-options {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .modality-option {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            border-radius: 999px;
            border: 1px solid #ddd;
            background: #f8f9fa;
            font-size: 12px;
            cursor: pointer;
        }

        .modality-option input {
            margin: 0;
        }

        body.dark .modality-option {
            background: #0f141b;
            border-color: #2a3b52;
            color: #e6edf3;
        }

        body.dark .databank-item {
            background: #0f141b;
            border-color: #2a3b52;
            color: #e6edf3;
        }

        body.dark .databank-item:hover {
            border-color: #4e85e9;
            color: #cfe0ff;
            background: #18263a;
        }

        body.dark .databank-item.active {
            background: #4e85e9;
            border-color: #4e85e9;
            color: #0b1320;
        }

        .hamburger-section-title {
            padding: 10px 16px;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: #7f8c8d;
            background: #f5f7fa;
            border-bottom: 1px solid #f0f0f0;
        }

        .hamburger-databanks {
            padding: 10px 12px 14px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .hamburger-databanks .databank-item {
            padding: 6px 10px;
            font-size: 12px;
        }

        .databank-create {
            width: 100%;
            padding: 10px 12px;
            border-radius: 10px;
            border: 1px dashed #4e85e9;
            background: #f5f9ff;
            color: #1f4b99;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .databank-create:hover {
            background: #e6f0ff;
            border-color: #2f6fe0;
        }

        body.dark .databank-create {
            background: #152235;
            border-color: #4e85e9;
            color: #cfe0ff;
        }

        body.dark .databank-create:hover {
            background: #1b2a40;
        }

        body.dark .hamburger-section-title {
            color: #9aa7b5;
            background: #121a24;
            border-bottom-color: #243244;
        }
    </style>
</head>
<body>
    <div class="top-bar">
        <div class="top-bar-left">
            <div class="hamburger-wrapper">
                <button id="top-index-hamburger" class="hamburger-button" aria-label="Open menu" aria-expanded="false" aria-controls="top-index-menu">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
                <div id="top-index-menu" class="hamburger-menu">
                    <a href="/dashboard?db={{ db_name }}">{{ t.dashboard }}</a>
                    <button type="button" onclick="toggleUploadZone(); closeTopIndexMenu();" class="menu-upload">{{ t.upload }}</button>
                    <button
                        type="button"
                        id="theme-toggle"
                        class="theme-toggle"
                        data-dark="{{ t.dark_mode }}"
                        data-light="{{ t.light_mode }}"
                        data-dark-icon="ph-moon"
                        data-light-icon="ph-sun"
                        aria-label="{{ t.dark_mode }}"
                        title="{{ t.dark_mode }}"
                    ><i class="ph ph-moon" aria-hidden="true"></i></button>
                    <div class="hamburger-lang">
                        <a href="/?db={{ db_name }}&lang=en" class="lang-toggle {% if lang == 'en' %}active{% endif %}">EN</a>
                        <a href="/?db={{ db_name }}&lang=de" class="lang-toggle {% if lang == 'de' %}active{% endif %}">DE</a>
                    </div>
                    <div class="hamburger-section-title">Databanks</div>
                    <div class="hamburger-databanks">
                        {% if databanks %}
                            {% for bank in databanks %}
                            <a href="/?db={{ bank }}&lang={{ lang }}" class="databank-item {% if bank == db_name %}active{% endif %}">{{ bank }}</a>
                            {% endfor %}
                        {% else %}
                            <span class="subtitle">No databanks found in Databanks/</span>
                        {% endif %}
                        <button type="button" class="databank-create" onclick="createDatabank();">Create databank</button>
                    </div>
                </div>
            </div>
            <div class="top-bar-copy">
                <span>{{ t.top_bar_primary }}</span>
                <strong>{{ t.top_bar_secondary }}</strong>
            </div>
        </div>
        <div class="top-bar-center">
            <span class="title-main">DICOM Metadata Browser</span>
            <span class="title-sub">&nbsp;</span>
        </div>
        <div class="top-bar-right">
            <img src="{{ url_for('tum_logo') }}" alt="TUM Logo">
        </div>
    </div>
    <div class="container">

        <!-- Upload Zone -->
        <div id="upload-zone" class="panel" style="display: none; padding: 30px; margin-bottom: 30px; border: 2px dashed #3498db; text-align: center; cursor: pointer; transition: all 0.3s;"
             ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" onclick="document.getElementById('file-input').click()">
            <input type="file" id="file-input" accept=".zip,.7z" style="display: none;" onchange="handleFileSelect(event)">
            <div id="upload-content">
                <h3 style="margin: 10px 0; color: #2c3e50;">{{ t.drop_files }}</h3>
                <p style="color: #7f8c8d; margin: 5px 0;">{{ t.click_to_browse }}</p>
                <p style="color: #95a5a6; font-size: 12px; margin-top: 10px;">{{ t.supports }}</p>
            </div>
            <div id="upload-progress" style="display: none;">
                <div style="margin: 20px 0;">
                    <div style="background: #ecf0f1; border-radius: 10px; height: 20px; overflow: hidden;">
                        <div id="progress-bar" style="background: #3498db; height: 100%; width: 0%; transition: width 0.3s;"></div>
                    </div>
                    <p id="progress-text" style="margin-top: 10px; color: #7f8c8d;">Processing...</p>
                </div>
            </div>
        </div>

        <!-- Search Form -->
        <div class="panel" style="padding: 20px; margin-bottom: 30px;">
            <form method="GET" action="/">
                <input type="hidden" name="db" value="{{ db_name }}">
                <input type="hidden" name="lang" value="{{ lang }}">
                <div style="display: flex; gap: 10px; align-items: center;">
                <input 
                    type="text" 
                    name="search" 
                    placeholder="{{ t.search_placeholder }}" 
                    value="{{ search_term or '' }}"
                    style="flex: 1; padding: 12px; border: 2px solid #ddd; border-radius: 6px; font-size: 16px;"
                    autofocus
                >
                <button 
                    type="submit" 
                    style="padding: 12px 24px; background: #3498db; color: white; border: none; border-radius: 6px; font-size: 16px; cursor: pointer; font-weight: 500;"
                >
                    {{ t.search }}
                </button>
                <button
                    type="button"
                    id="filters-toggle"
                    class="filter-toggle"
                    aria-expanded="{{ 'true' if has_filters else 'false' }}"
                    aria-controls="filters-panel"
                >
                    {{ t.filters or 'Filters' }}
                </button>
                {% if search_term %}
                <a 
                    href="/?db={{ db_name }}&lang={{ lang }}" 
                    style="padding: 12px 20px; background: #95a5a6; color: white; border-radius: 6px; text-decoration: none; font-size: 16px;"
                >
                    {{ t['clear'] }}
                </a>
                {% endif %}
                </div>
                <div id="filters-panel" class="filter-panel {% if has_filters %}open{% endif %}">
                <div class="filter-row">
                    <input type="number" step="0.1" name="uptake_min" placeholder="{{ t.uptake_time_min or 'Uptake time min' }}" value="{{ uptake_min if uptake_min is not none else '' }}">
                    <input type="number" step="0.1" name="uptake_max" placeholder="{{ t.uptake_time_max or 'Uptake time max' }}" value="{{ uptake_max if uptake_max is not none else '' }}">
                    <input type="number" step="0.01" name="dose_min" placeholder="{{ t.dose_per_kg_min or 'Dose per kg min' }}" value="{{ dose_min if dose_min is not none else '' }}">
                    <input type="number" step="0.01" name="dose_max" placeholder="{{ t.dose_per_kg_max or 'Dose per kg max' }}" value="{{ dose_max if dose_max is not none else '' }}">
                    <div class="filter-actions">
                        <button 
                            type="submit" 
                            style="padding: 10px 16px; background: #3498db; color: white; border: none; border-radius: 6px; font-size: 14px; cursor: pointer; font-weight: 500;"
                        >
                            {{ t.apply_filters or 'Apply filters' }}
                        </button>
                        {% if has_filters %}
                        <a href="/?db={{ db_name }}&lang={{ lang }}{% if search_term %}&search={{ search_term }}{% endif %}" style="color: #7f8c8d; text-decoration: none; font-size: 14px;">
                            {{ t.clear_filters or 'Clear filters' }}
                        </a>
                        {% endif %}
                    </div>
                </div>
                {% if available_modalities %}
                <div class="modality-filters">
                    <span style="font-size: 12px; color: #7f8c8d; text-transform: uppercase;">{{ t.modalities or 'Modalities' }}</span>
                    <div class="modality-options">
                        {% for modality in available_modalities %}
                        <label class="modality-option">
                            <input type="checkbox" name="modality" value="{{ modality }}" {% if modality in modality_filters %}checked{% endif %}>
                            <span>{{ modality }}</span>
                        </label>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                {% if available_manufacturers %}
                <div class="modality-filters" style="margin-top: 16px;">
                    <span style="font-size: 12px; color: #7f8c8d; text-transform: uppercase;">{{ t.manufacturer or 'Manufacturer' }}</span>
                    <div class="modality-options">
                        {% for manufacturer in available_manufacturers %}
                        <label class="modality-option">
                            <input type="checkbox" name="manufacturer" value="{{ manufacturer }}" {% if manufacturer in manufacturer_filters %}checked{% endif %}>
                            <span>{{ manufacturer }}</span>
                        </label>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                {% if available_radiopharmaceuticals %}
                <div class="modality-filters" style="margin-top: 16px;">
                    <span style="font-size: 12px; color: #7f8c8d; text-transform: uppercase;">{{ t.radiopharmaceutical or 'Radiopharmaceutical' }}</span>
                    <div class="modality-options">
                        {% for radiopharmaceutical in available_radiopharmaceuticals %}
                        <label class="modality-option">
                            <input type="checkbox" name="radiopharmaceutical" value="{{ radiopharmaceutical }}" {% if radiopharmaceutical in radiopharmaceutical_filters %}checked{% endif %}>
                            <span>{{ radiopharmaceutical }}</span>
                        </label>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                </div>
            </form>
            {% if search_term %}
            <p style="margin-top: 10px; color: #7f8c8d; font-size: 14px;">
                {{ t.searching_for }}: <strong>{{ search_term }}</strong>
                {% if studies %}
                    <span style="color: #27ae60;">({{ studies|length }} {{ t.results_found }})</span>
                {% else %}
                    <span style="color: #e74c3c;">({{ t.no_results }})</span>
                {% endif %}
            </p>
            {% endif %}
        </div>
        
        {% if deleted == '1' %}
        <div style="background: #d4edda; border: 1px solid #c3e6cb; color: #155724; padding: 15px; border-radius: 4px; margin-bottom: 20px;">
            <strong>{{ t.success }}:</strong> {{ t.study_deleted }} ({{ deleted_count }} {{ t.series_removed }}).
        </div>
        {% endif %}
        
        {% if error %}
        <div class="error">
            <strong>Error:</strong> {{ error }}
        </div>
        {% endif %}
        
        {% if studies %}
        <div class="studies-grid">
            {% for study in studies %}
            <a href="/study/{{ study.study_instance_uid }}?db={{ db_name }}&lang={{ lang }}">
                <div class="study-card">
                    <h3>
                        {% if study.patient_name_display %}
                            {{ study.patient_name_display }}
                        {% elif study.patient_name %}
                            {{ study.patient_name }}
                        {% else %}
                            Study {{ loop.index }}
                        {% endif %}
                    </h3>
                    <div class="study-info">
                        <div class="info-row">
                            <span class="info-label">{{ t.patient_id }}:</span>
                            <span class="info-value">{{ study.patient_id or 'N/A' }}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">{{ t.study_date }}:</span>
                            <span class="info-value">{{ study.study_date_formatted or study.study_date or 'N/A' }}</span>
                        </div>
                        {% if study.study_time_formatted %}
                        <div class="info-row">
                            <span class="info-label">{{ t.study_time }}:</span>
                            <span class="info-value">{{ study.study_time_formatted }}</span>
                        </div>
                        {% endif %}
                        {% if study.study_description %}
                        <div class="info-row">
                            <span class="info-label">{{ t.description }}:</span>
                            <span class="info-value" style="font-size: 12px;">{{ study.study_description[:50] }}{% if study.study_description|length > 50 %}...{% endif %}</span>
                        </div>
                        {% endif %}
                        <div class="info-row" style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #eee;">
                            <div class="badge-row">
                                {% if study.modality %}
                                <span class="badge badge-modality" title="{{ study.modality }}">{{ study.modality }}</span>
                                {% endif %}
                                {% if study.manufacturer %}
                                <span class="badge badge-manufacturer" title="{{ study.manufacturer }}">{{ study.manufacturer }}</span>
                                {% endif %}
                                {% if study.radiopharmaceutical %}
                                <span class="badge" style="background: #16a085; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px;" title="{{ study.radiopharmaceutical }}">{{ study.radiopharmaceutical[:15] }}{% if study.radiopharmaceutical|length > 15 %}...{% endif %}</span>
                                {% endif %}
                                <span class="badge series-count">{{ study.series_count }} {{ t.series }}</span>
                            </div>
                        </div>
                        {% if search_term and study.match_score %}
                        <div style="margin-top: 8px; font-size: 11px; color: #7f8c8d;">
                            Match: {{ "%.0f"|format(study.match_score * 100) }}%
                        </div>
                        {% endif %}
                    </div>
                </div>
            </a>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-state">
            {% if search_term %}
            <h2>{{ t.no_results_found }}</h2>
            <p>{{ t.no_matches }} "<strong>{{ search_term }}</strong>"</p>
            <p style="margin-top: 15px;">
                <a href="/?db={{ db_name }}&lang={{ lang }}" style="color: #3498db; text-decoration: underline;">{{ t.show_all_studies }}</a>
            </p>
            {% else %}
            <h2>{{ t.no_studies_found }}</h2>
            <p>{{ t.process_files }}<br><code>python3 process_dicom.py &lt;directory&gt;</code></p>
            {% endif %}
        </div>
        {% endif %}
    </div>

    <script>
        const uploadZone = document.getElementById('upload-zone');
        const uploadContent = document.getElementById('upload-content');
        const uploadProgress = document.getElementById('upload-progress');
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        const filtersToggle = document.getElementById('filters-toggle');
        const filtersPanel = document.getElementById('filters-panel');

        function toggleUploadZone() {
            if (uploadZone.style.display === 'none' || uploadZone.style.display === '') {
                uploadZone.style.display = 'block';
            } else {
                uploadZone.style.display = 'none';
                // Reset upload state when closing
                uploadContent.style.display = 'block';
                uploadProgress.style.display = 'none';
                progressBar.style.width = '0%';
                progressBar.style.background = '#3498db';
            }
        }

        if (filtersToggle && filtersPanel) {
            filtersToggle.addEventListener('click', () => {
                const isOpen = filtersPanel.classList.toggle('open');
                filtersToggle.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
            });
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.stopPropagation();
            uploadZone.style.borderColor = '#2980b9';
            uploadZone.style.background = '#f0f8ff';
        }

        function handleDragLeave(e) {
            e.preventDefault();
            e.stopPropagation();
            uploadZone.style.borderColor = '#3498db';
            uploadZone.style.background = 'white';
        }

        function handleDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            uploadZone.style.borderColor = '#3498db';
            uploadZone.style.background = 'white';

            const files = Array.from(e.dataTransfer.files);
            files.forEach(file => {
                if (file.name.endsWith('.zip') || file.name.endsWith('.7z')) {
                    uploadFile(file);
                } else {
                    alert('Only ZIP and 7Z files are supported.');
                }
            });
        }

        function handleFileSelect(e) {
            const files = Array.from(e.target.files);
            files.forEach(file => {
                if (file.name.endsWith('.zip') || file.name.endsWith('.7z')) {
                    uploadFile(file);
                } else {
                    alert('Only ZIP and 7Z files are supported.');
                }
            });
        }

        function uploadFile(file) {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('db', '{{ db_name }}');

            uploadContent.style.display = 'none';
            uploadProgress.style.display = 'block';
            progressBar.style.width = '0%';
            progressText.textContent = `{{ t.uploading }} ${file.name}...`;

            fetch('/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    progressBar.style.width = '100%';
                    progressText.textContent = `{{ t.success }}: ${data.message}`;
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else {
                    progressText.textContent = `{{ t.error }}: ${data.message}`;
                    progressBar.style.background = '#e74c3c';
                    setTimeout(() => {
                        uploadContent.style.display = 'block';
                        uploadProgress.style.display = 'none';
                        progressBar.style.background = '#3498db';
                        progressBar.style.width = '0%';
                    }, 3000);
                }
            })
            .catch(error => {
                progressText.textContent = `{{ t.error }}: ${error.message}`;
                progressBar.style.background = '#e74c3c';
                setTimeout(() => {
                    uploadContent.style.display = 'block';
                    uploadProgress.style.display = 'none';
                    progressBar.style.background = '#3498db';
                    progressBar.style.width = '0%';
                }, 3000);
            });
        }

        function createDatabank() {
            const name = prompt('New databank name');
            if (!name) {
                return;
            }
            const formData = new FormData();
            formData.append('name', name);
            fetch('/databanks/create', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const target = `/?db=${encodeURIComponent(data.name)}&lang={{ lang }}`;
                    window.location.href = target;
                } else {
                    alert(data.message || 'Failed to create databank.');
                }
            })
            .catch(error => {
                alert(error.message || 'Failed to create databank.');
            });
            closeTopIndexMenu();
        }

        const topMenuButton = document.getElementById('top-index-hamburger');
        const topMenu = document.getElementById('top-index-menu');
        const themeToggleButton = document.getElementById('theme-toggle');

        if (topMenuButton && topMenu) {
            topMenuButton.addEventListener('click', (event) => {
                event.stopPropagation();
                const expanded = topMenuButton.getAttribute('aria-expanded') === 'true';
                topMenuButton.setAttribute('aria-expanded', String(!expanded));
                topMenu.classList.toggle('open', !expanded);
            });

            document.addEventListener('click', (event) => {
                if (!topMenu.contains(event.target) && !topMenuButton.contains(event.target)) {
                    topMenuButton.setAttribute('aria-expanded', 'false');
                    topMenu.classList.remove('open');
                }
            });
        }

        function closeTopIndexMenu() {
            if (topMenuButton && topMenu) {
                topMenuButton.setAttribute('aria-expanded', 'false');
                topMenu.classList.remove('open');
            }
        }

        function applyTheme(theme) {
            const isDark = theme === 'dark';
            document.body.classList.toggle('dark', isDark);
            if (themeToggleButton) {
                const nextLabel = isDark
                    ? (themeToggleButton.dataset.light || 'Light Mode')
                    : (themeToggleButton.dataset.dark || 'Dark Mode');
                const nextIcon = isDark
                    ? (themeToggleButton.dataset.lightIcon || 'ph-sun')
                    : (themeToggleButton.dataset.darkIcon || 'ph-moon');
                themeToggleButton.innerHTML = `<i class="ph ${nextIcon}" aria-hidden="true"></i>`;
                themeToggleButton.setAttribute('aria-label', nextLabel);
                themeToggleButton.setAttribute('title', nextLabel);
            }
            localStorage.setItem('theme', theme);
        }

        if (themeToggleButton) {
            themeToggleButton.addEventListener('click', () => {
                const nextTheme = document.body.classList.contains('dark') ? 'light' : 'dark';
                applyTheme(nextTheme);
                closeTopIndexMenu();
            });
        }

        const storedTheme = localStorage.getItem('theme') || 'light';
        applyTheme(storedTheme);
    </script>
</body>
</html>
